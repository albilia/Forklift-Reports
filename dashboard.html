<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>××¢×¨×›×ª ×“×•×•×—×™×</title>

    <!-- ××¤×œ×™×§×¦×™×” ××œ××” ×‘××™×™×¤×•×Ÿ ×•×× ×“×¨×•××™×“ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            text-align: center;
        }

        /* ×’×œ×™×œ×” ×¤× ×™××™×ª ×—×œ×§×” */
        .app-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            background: #d32f2f;
            color: white;
            padding: 15px;
            padding-top: env(safe-area-inset-top);
            font-size: 22px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .section {
            margin-top: 25px;
        }

        button {
            width: 260px;
            padding: 14px;
            font-size: 18px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: #b71c1c;
        }

        select {
            width: 260px;
            padding: 12px;
            font-size: 18px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        #preview {
            margin-top: 20px;
            max-width: 90%;
            border-radius: 10px;
            display: none;
        }

        #historyBox {
            margin-top: 25px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            width: 95%;
            margin-left: auto;
            margin-right: auto;
            display: none;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 16px;
            text-align: center;
        }

        th {
            background-color: #f44336;
            color: white;
        }

        #filters {
            margin-top: 10px;
            text-align: right;
        }

        #filters input {
            padding: 8px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .logout {
            margin-top: 40px;
            color: #444;
            cursor: pointer;
            text-decoration: underline;
        }

        /* â­â­â­ ××¦×‘ ×›×”×” â€” ××•×¤×¢×œ ×™×“× ×™×ª â­â­â­ */
        body.dark {
            background: #121212;
            color: white;
        }

        body.dark .header {
            background: #b71c1c;
        }

        body.dark select,
        body.dark input {
            background: #1e1e1e;
            color: white;
            border: 1px solid #555;
        }

        body.dark button {
            background: #b71c1c;
        }

        body.dark #historyBox {
            background: #1e1e1e;
            color: white;
        }

        body.dark table, 
        body.dark th, 
        body.dark td {
            border-color: #444;
        }

        body.dark th {
            background: #d32f2f;
        }

        body.dark .logout {
            color: #bbb;
        }
    </style>
</head>

<body>

<div class="app-container">

    <div class="header">
        <span>××¢×¨×›×ª ×“×•×•×—×™×</span>
        <button class="dark-toggle" onclick="toggleDarkMode()">××¦×‘ ×›×”×”</button>
    </div>

    <div class="section">
        <h3>×©×œ×•×, <span id="driverName"></span></h3>

        <select id="warehouse" onchange="toggleSubWarehouse()">
            <option value="">×‘×—×¨ ××—×¡×Ÿ...</option>
            <option value="raw">××—×¡×Ÿ ×—×•××¨×™ ×’×œ×</option>
            <option value="finished">××—×¡×Ÿ ×ª×•×¦×¨ ×’××¨</option>
        </select>

        <select id="subWarehouse" style="display:none;">
            <option value="">×‘×—×¨ ×ª×ªÖ¾××—×¡×Ÿ...</option>
            <option>×“× ×™×“×™×Ÿ</option>
            <option>×‘×¦×§ ×¡×•×›×¨ ×©×××œ</option>
            <option>×‘×¦×§ ×¡×•×›×¨ ×™××™×Ÿ</option>
            <option>×©×“×¨×” ××¨×›×–×™×ª ×¨×¦×¤×”</option>
            <option>×©×“×¨×” ××¨×›×–×™×ª ×©×××œ</option>
            <option>×©×“×¨×” ××¨×›×–×™×ª ×™××™×Ÿ</option>
            <option>×©×“×¨×” ×©×××œ</option>
            <option>×©×“×¨×” ×©×××œ ×©×××œ</option>
            <option>×©×“×¨×” ×©×××œ ×ª×—×ª ×”×’×œ×¨×™×”</option>
            <option>×›× ×™×¡×” ×©×××œ</option>
            <option>×›× ×™×¡×” ×™××™×Ÿ</option>
            <option>××—×¡×Ÿ ×—×“×© ×©×××œ</option>
            <option>××—×¡×Ÿ ×—×“×© ×™××™×Ÿ</option>
            <option>×§×œ×•×™ ×§×œ×•×£ ××—×¡×Ÿ</option>
            <option>×§×œ×•×™ ×§×œ×•×£ ×˜×•×¨</option>
        </select>

        <br>

        <button onclick="openCamera()">×¦×œ× ×“×•"×—</button>

        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="showPreview(event)">

        <img id="preview">
    </div>

    <button onclick="sendReport()">×©×œ×— ×“×™×•×•×—</button>

    <button onclick="loadHistory()">×”×™×¡×˜×•×¨×™×™×ª ×“×™×•×•×—×™×</button>

    <div id="historyBox"></div>

    <div class="logout" onclick="logout()">×”×ª× ×ª×§</div>

</div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbzU-EYczORrSOsCj1yD9ogw4U0BzqarOGhekbILa_-zOFlCHMfcfC2zWEBIErETME3SJQ/exec";

const token = localStorage.getItem("sessionToken");
const driverName = localStorage.getItem("driverName");

if (!token) {
    window.location.href = "index.html";
}

document.getElementById("driverName").innerText = driverName;

/* â­ Dark Mode â€” ×©××™×¨×” ×•×”×¤×¢×œ×” â­ */
function applySavedTheme() {
    const mode = localStorage.getItem("theme");
    if (mode === "dark") {
        document.body.classList.add("dark");
        document.querySelector(".dark-toggle").innerText = "××¦×‘ ×‘×”×™×¨";
    }
}

function toggleDarkMode() {
    document.body.classList.toggle("dark");

    const isDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");

    document.querySelector(".dark-toggle").innerText =
        isDark ? "××¦×‘ ×‘×”×™×¨" : "××¦×‘ ×›×”×”";
}

applySavedTheme();

/* â­ ×”××©×š ×”×§×•×“ ×”××§×•×¨×™ â­ */

let lastImageBase64 = "";

function toggleSubWarehouse() {
    const warehouse = document.getElementById("warehouse").value;
    const sub = document.getElementById("subWarehouse");

    if (warehouse === "finished") {
        sub.style.display = "block";
    } else {
        sub.style.display = "none";
        sub.value = "";
    }
}

function openCamera() {
    document.getElementById("cameraInput").click();
}

function showPreview(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        lastImageBase64 = e.target.result;
        const img = document.getElementById("preview");
        img.src = lastImageBase64;
        img.style.display = "block";
    };

    reader.readAsDataURL(file);
}

async function sendReport() {
    const warehouse = document.getElementById("warehouse").value;
    const subWarehouse = document.getElementById("subWarehouse").value;

    if (!warehouse) {
        alert("×‘×—×¨ ××—×¡×Ÿ");
        return;
    }

    if (warehouse === "finished" && !subWarehouse) {
        alert("×‘×—×¨ ×ª×ªÖ¾××—×¡×Ÿ");
        return;
    }

    if (!lastImageBase64) {
        alert("×¦×œ× ×“×•\"×— ×œ×¤× ×™ ×©×œ×™×—×”");
        return;
    }

    try {
        const ocrResponse = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "processImage",
                image: lastImageBase64
            })
        }).then(res => res.json());

        if (!ocrResponse.success) {
            alert("×©×’×™××” ×‘×¤×¢× ×•×— OCR");
            return;
        }

        const saveResponse = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: warehouse === "raw" ? "saveRawMaterial" : "saveReport",
                token: token,
                ocr: ocrResponse.parsed,
                subWarehouse: subWarehouse
            })
        }).then(res => res.json());

        if (saveResponse.success) {
            alert("×”×“×™×•×•×— × ×©××¨ ×‘×”×¦×œ×—×”");
            lastImageBase64 = "";
            document.getElementById("preview").style.display = "none";
        } else {
            alert("×©×’×™××” ×‘×©×œ×™×—×”");
        }

    } catch (err) {
        console.error(err);
        alert("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª");
    }
}

function loadHistory() {
    const warehouse = document.getElementById("warehouse").value;

    if (!warehouse) {
        alert("×‘×—×¨ ××—×¡×Ÿ ×œ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×”");
        return;
    }

    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "getHistory",
            token: token,
            warehouse: warehouse
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”");
            return;
        }

        const box = document.getElementById("historyBox");
        box.style.display = "block";

        if (data.data.length === 0) {
            box.innerHTML = "<b>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</b>";
            return;
        }

        box.innerHTML = `
            <div id="filters">
                <input type="date" id="fromDate">
                <input type="date" id="toDate">
                <input type="text" id="searchText" placeholder="×—×™×¤×•×© ×œ×¤×™ ××§×´×˜ / ×¤×§×´×¢ / ×©×">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ğŸ“… ×ª××¨×™×š</th>
                        <th>â° ×©×¢×”</th>
                        <th>ğŸ”¢ ××§"×˜</th>
                        <th>ğŸ“¦ ×¤×§"×¢</th>
                        <th>ğŸ”¢ ×›××•×ª</th>
                        <th>ğŸ‘¤ ××“×•×•×—</th>
                    </tr>
                </thead>
                <tbody id="historyRows"></tbody>
            </table>
        `;

        const tbody = document.getElementById("historyRows");

        function renderTable() {
            const from = document.getElementById("fromDate").value;
            const to = document.getElementById("toDate").value;
            const search = document.getElementById("searchText").value.trim();

            tbody.innerHTML = "";

            data.data.forEach(row => {
                const date = row[0].split(" ")[0];
                const makat = row[2] || "";
                const pka = row[3] || "";
                const qty = row[4] || "";
                const user = row[6] || "";

                if (from && date < from) return;
                if (to && date > to) return;

                if (search && !(
                    makat.includes(search) ||
                    pka.includes(search) ||
                    user.includes(search)
                )) return;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${makat}</td>
                    <td>${pka}</td>
                    <td>${qty}</td>
                    <td>${user}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById("fromDate").onchange = renderTable;
        document.getElementById("toDate").onchange = renderTable;
        document.getElementById("searchText").oninput = renderTable;

        renderTable();
    });
}

function logout() {
    localStorage.clear();
    window.location.href = "index.html";
}

</script>

</html>
