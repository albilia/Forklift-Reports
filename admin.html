<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>דשבורד מנהל – דו"ח תנועות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; background:#101820; color:#f5f5f5; margin:0; }
    header { padding:15px 20px; background:#1c2833; display:flex; justify-content:space-between; border-bottom:2px solid #263445; }
    header h1 { margin:0; font-size:22px; }
    #backBtn,#refreshBtn { background:#607d8b; color:white; border:none; padding:8px 14px; border-radius:8px; font-weight:bold; cursor:pointer; }
    main { padding:15px; }

    .filters { background:#17212b; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; flex-wrap:wrap; gap:8px; border:1px solid #263445; }
    .filters button { background:#263445; color:#f5f5f5; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .filters input[type="date"] { background:#101820; color:#f5f5f5; border:1px solid #455a64; border-radius:6px; padding:4px 6px; }

    .accordion-section { margin-bottom:10px; border-radius:10px; overflow:hidden; background:#17212b; border:1px solid #263445; }
    .accordion-header { padding:10px 12px; background:#1f2a36; cursor:pointer; display:flex; justify-content:space-between; font-weight:bold; }
    .accordion-header.open .arrow { transform:rotate(90deg); }
    .accordion-content { max-height:0; overflow:hidden; transition:max-height .25s ease; }
    .accordion-inner { padding:8px 10px; }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    thead { background:#263445; position:sticky; top:0; }
    th,td { padding:6px 4px; border-bottom:1px solid #263445; white-space:nowrap; text-align:center; }

    tbody tr:nth-child(even){ background:#1f2a36; }
    tbody tr:nth-child(odd){ background:#141c24; }

    .table-wrapper { max-height:320px; overflow:auto; border-radius:8px; border:1px solid #263445; }

    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-bottom:15px; }
    .card { background:#17212b; border-radius:10px; padding:10px; text-align:center; border:1px solid #263445; }
    .card-title { font-size:13px; color:#b0bec5; }
    .card-value { font-size:20px; font-weight:bold; color:#ffeb3b; }

    .loader { display:none; text-align:center; margin:15px 0; color:#ffeb3b; font-weight:bold; }
    .error { color:#ff5252; text-align:center; margin:10px 0; font-weight:bold; }

    #chartsSection { margin-top:40px; padding:20px; background:#17212b; border-radius:10px; border:1px solid #263445; }

    /* סיכום טקסטואלי לפי מק"ט מעל הטבלה */
    #makatSummaryText {
      font-size:13px;
      color:#cfd8dc;
      margin-bottom:8px;
      line-height:1.6;
      white-space:nowrap;
      overflow-x:auto;
    }

    /* רמז קטן לגרירת עמודות */
    th.resizable {
      position:relative;
    }
    th.resizable::after {
      content:"";
      position:absolute;
      left:0;
      top:0;
      width:4px;
      height:100%;
      cursor:col-resize;
    }
  </style>
</head>

<body>

<header>
  <h1>דשבורד מנהל – דו"ח תנועות</h1>
  <div>
    <button id="refreshBtn">רענון</button>
    <button id="backBtn" onclick="goBack()">חזור</button>
  </div>
</header>

<main>

  <div class="filters">
    <div>
      <button onclick="setQuickRange('today')">היום</button>
      <button onclick="setQuickRange('week')">שבוע</button>
      <button onclick="setQuickRange('month')">חודש</button>
    </div>

    <div>
      <label>מתאריך:</label>
      <input type="date" id="fromDate" onchange="applyFilters()">
      <label>עד תאריך:</label>
      <input type="date" id="toDate" onchange="applyFilters()">
    </div>

    <div>
      <button onclick="setShift('morning')">משמרת בוקר</button>
      <button onclick="setShift('evening')">משמרת ערב</button>
    </div>
  </div>

  <div class="summary-cards">
    <div class="card"><div class="card-title">סה"כ דווחים</div><div class="card-value" id="totalReports">0</div></div>
    <div class="card"><div class="card-title">סה"כ משטחים</div><div class="card-value" id="totalPallets">0</div></div>
    <div class="card"><div class="card-title">סה"כ יחידות</div><div class="card-value" id="totalUnits">0</div></div>
    <div class="card"><div class="card-title">סה"כ עובדים</div><div class="card-value" id="totalWorkers">0</div></div>
  </div>

  <div class="loader" id="loader">טוען נתונים...</div>
  <div class="error" id="errorMsg"></div>

  <!-- אקורדיון: סיכום לפי מק"ט -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מק"ט</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <!-- סיכום טקסטואלי לפי מק"ט -->
        <div id="makatSummaryText"></div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th class="resizable">מק"ט</th>
                <th class="resizable">תאריך</th>
                <th class="resizable">שעה</th>
                <th class="resizable">עובד</th>
                <th class="resizable">מספר פק"ע</th>
                <th class="resizable">כמות</th>
                <th class="resizable">סה"כ כמות</th>
                <th class="resizable">משטחים</th>
              </tr>
            </thead>
            <tbody id="tableByMakat"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: סיכום לפי עובדים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי עובדים</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th class="resizable">עובד</th>
                <th class="resizable">דווחים</th>
                <th class="resizable">משטחים</th>
                <th class="resizable">סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWorker"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: סיכום לפי מחסן -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מחסן</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th class="resizable">מחסן</th>
                <th class="resizable">תת־מחסן</th>
                <th class="resizable">דווחים</th>
                <th class="resizable">משטחים</th>
                <th class="resizable">סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWarehouse"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: דווחים גולמיים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>דווחים גולמיים</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th class="resizable">תאריך</th>
                <th class="resizable">שעה</th>
                <th class="resizable">עובד</th>
                <th class="resizable">מק"ט</th>
                <th class="resizable">פק"ע</th>
                <th class="resizable">כמות</th>
                <th class="resizable">משטח</th>
                <th class="resizable">מחסן</th>
                <th class="resizable">תת־מחסן</th>
              </tr>
            </thead>
            <tbody id="tableRawReports"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <section id="chartsSection">
    <canvas id="makatPieChart"></canvas>
  </section>

</main>

<script>
function goBack() { 
  window.history.back(); 
}

// אקורדיון
function toggleAccordion(header){
  header.classList.toggle("open");
  const content = header.nextElementSibling;
  content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
}

// טווחים מהירים
function setQuickRange(type){
  const today = new Date();
  let from = new Date();
  let to = new Date();

  if(type === "week") from.setDate(today.getDate() - 7);
  if(type === "month") from.setMonth(today.getMonth() - 1);

  document.getElementById("fromDate").value = from.toISOString().split("T")[0];
  document.getElementById("toDate").value = to.toISOString().split("T")[0];

  applyFilters();
}

// משמרות
function setShift(shift){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if(!from || !to){
    alert("בחר טווח תאריכים לפני בחירת משמרת");
    return;
  }

  window.selectedShift = 
    shift === "morning" 
      ? { startHour: 6, endHour: 14 } 
      : { startHour: 14, endHour: 22 };

  applyFilters();
}

// טעינת נתונים
async function applyFilters(){
  const loader = document.getElementById("loader");
  const errorMsg = document.getElementById("errorMsg");

  loader.style.display = "block";
  errorMsg.textContent = "";

  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if(!from || !to){
    loader.style.display = "none";
    return;
  }

  try{
    const response = await fetch(
      `https://script.google.com/macros/s/AKfycbwJX4IaxmTmNx0re1ifoEPxgbsh6rAkFfmaehHDkJKW0LViqLtnkiCCg8uzsaA3PTtJEg/exec?from=${from}&to=${to}`
    );

    let data = await response.json();
    loader.style.display = "none";

    if(!data.length){
      errorMsg.textContent = "לא נמצאו נתונים";
      return;
    }

    // המרת תאריך ישראלי ל־Date
    data.forEach(r => {
      r._dateObj = new Date(r.date.split("/").reverse().join("-"));
    });

    processData(data);

  } catch(err){
    loader.style.display = "none";
    errorMsg.textContent = "שגיאה בטעינת הנתונים";
  }
}

// עיבוד נתונים
function processData(data){
  const shift = window.selectedShift;

  if(shift){
    data = data.filter(row => {
      const hour = Number(row.time.split(":")[0].padStart(2, "0"));
      return hour >= shift.startHour && hour < shift.endHour;
    });
  }

  fillSummary(data);
  fillByMakat(data);
  fillByWorker(data);
  fillByWarehouse(data);
  fillRawReports(data);
  drawPieChart(data);
}

// סיכום עליון
function fillSummary(data){
  document.getElementById("totalReports").textContent = data.length;

  const pallets = new Set();
  const workers = new Set();
  let units = 0;

  data.forEach(row => {
    // דווח = תאריך+שעה+עובד+מק"ט
    const reportKey = `${row.date}|${row.time}|${row.worker}|${row.makat}`;
    pallets.add(reportKey);
    workers.add(row.worker);
    units += Number(row.qty);
  });

  document.getElementById("totalPallets").textContent = pallets.size;
  document.getElementById("totalUnits").textContent = units;
  document.getElementById("totalWorkers").textContent = workers.size;
}

// סיכום לפי מק"ט (לוגיקה החדשה)
function fillByMakat(data){
  const table = document.getElementById("tableByMakat");
  const summaryDiv = document.getElementById("makatSummaryText");
  table.innerHTML = "";
  summaryDiv.textContent = "";

  if(!data.length) return;

  // קיבוץ לפי מק"ט
  const byMakat = {};
  data.forEach(row => {
    const makat = row.makat || "לא מוגדר";
    if(!byMakat[makat]) {
      byMakat[makat] = {
        rows: [],
        reports: new Set(),
        totalQty: 0
      };
    }
    const reportKey = `${row.date}|${row.time}|${row.worker}|${row.makat}`;
    byMakat[makat].rows.push({
      date: row.date,
      time: row.time,
      worker: row.worker,
      pka: row.pka,
      qty: Number(row.qty) || 0,
      reportKey
    });
    byMakat[makat].reports.add(reportKey);
    byMakat[makat].totalQty += Number(row.qty) || 0;
  });

  // מיון מק"טים
  const makats = Object.keys(byMakat).sort();

  // בניית טקסט סיכום מעל הטבלה
  const summaryLines = [];
  makats.forEach(makat => {
    const g = byMakat[makat];
    const reportsCount = g.reports.size;
    const totalQty = g.totalQty;
    const reportsLabel = reportsCount === 1 ? "1 דווח" : `${reportsCount} דווחים`;
    summaryLines.push(`← מק״ט ${makat} — ${reportsLabel} ← סה״כ כמות: ${totalQty} ← משטחים: ${reportsCount}`);
  });
  summaryDiv.innerHTML = summaryLines.join("<br>");

  // בניית הטבלה: שורה ראשונה של כל מק"ט עם סיכומים, השאר בלי
  makats.forEach(makat => {
    const g = byMakat[makat];

    // מיון השורות בתוך מק"ט לפי תאריך+שעה
    g.rows.sort((a,b) => {
      const da = a.date.split("/").reverse().join("-") + " " + a.time;
      const db = b.date.split("/").reverse().join("-") + " " + b.time;
      return da.localeCompare(db);
    });

    g.rows.forEach((r, index) => {
      const tr = document.createElement("tr");

      const tdMakat = document.createElement("td");
      const tdDate = document.createElement("td");
      const tdTime = document.createElement("td");
      const tdWorker = document.createElement("td");
      const tdPka = document.createElement("td");
      const tdQty = document.createElement("td");
      const tdTotalQty = document.createElement("td");
      const tdPallets = document.createElement("td");

      tdMakat.textContent = index === 0 ? makat : "";
      tdDate.textContent = r.date;
      tdTime.textContent = r.time;
      tdWorker.textContent = r.worker;
      tdPka.textContent = r.pka;
      tdQty.textContent = r.qty;

      if(index === 0){
        tdTotalQty.textContent = g.totalQty;
        tdPallets.textContent = g.reports.size;
        tdMakat.style.fontWeight = "bold";
        tdTotalQty.style.fontWeight = "bold";
        tdPallets.style.fontWeight = "bold";
      } else {
        tdTotalQty.textContent = "";
        tdPallets.textContent = "";
      }

      tr.appendChild(tdMakat);
      tr.appendChild(tdDate);
      tr.appendChild(tdTime);
      tr.appendChild(tdWorker);
      tr.appendChild(tdPka);
      tr.appendChild(tdQty);
      tr.appendChild(tdTotalQty);
      tr.appendChild(tdPallets);

      table.appendChild(tr);
    });
  });

  makeColumnsResizable();
}

// סיכום לפי עובדים
function fillByWorker(data){
  const table = document.getElementById("tableByWorker");
  table.innerHTML = "";

  const grouped = {};

  data.forEach(row => {
    const worker = row.worker || "ללא שם";
    if(!grouped[worker]){
      grouped[worker] = {
        reports: new Set(),
        pallets: new Set(),
        units: 0
      };
    }
    const reportKey = `${row.date}|${row.time}|${row.worker}|${row.makat}`;
    grouped[worker].reports.add(reportKey);
    grouped[worker].pallets.add(reportKey);
    grouped[worker].units += Number(row.qty) || 0;
  });

  Object.keys(grouped).forEach(worker => {
    const g = grouped[worker];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${worker}</td>
      <td>${g.reports.size}</td>
      <td>${g.pallets.size}</td>
      <td>${g.units}</td>
    `;
    table.appendChild(tr);
  });

  makeColumnsResizable();
}

// סיכום לפי מחסן
function fillByWarehouse(data){
  const table = document.getElementById("tableByWarehouse");
  table.innerHTML = "";

  const grouped = {};

  data.forEach(row => {
    const key = row.wh + "-" + row.subwh;

    if(!grouped[key]){
      grouped[key] = {
        wh: row.wh,
        subwh: row.subwh,
        reports: new Set(),
        pallets: new Set(),
        units: 0
      };
    }

    const reportKey = `${row.date}|${row.time}|${row.worker}|${row.makat}`;
    grouped[key].reports.add(reportKey);
    grouped[key].pallets.add(reportKey);
    grouped[key].units += Number(row.qty) || 0;
  });

  Object.values(grouped).forEach(g => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${g.wh}</td>
      <td>${g.subwh}</td>
      <td>${g.reports.size}</td>
      <td>${g.pallets.size}</td>
      <td>${g.units}</td>
    `;
    table.appendChild(tr);
  });

  makeColumnsResizable();
}

// דווחים גולמיים
function fillRawReports(data){
  const table = document.getElementById("tableRawReports");
  table.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.date}</td>
      <td>${row.time}</td>
      <td>${row.worker}</td>
      <td>${row.makat}</td>
      <td>${row.pka}</td>
      <td>${row.qty}</td>
      <td>${row.pallet || ""}</td>
      <td>${row.wh}</td>
      <td>${row.subwh}</td>
    `;
    table.appendChild(tr);
  });

  makeColumnsResizable();
}

// גרף דונאט
let makatChart = null;

function drawPieChart(data){
  const ctx = document.getElementById("makatPieChart").getContext("2d");

  const counts = {};
  data.forEach(row => {
    const makat = row.makat || "לא מוגדר";
    counts[makat] = (counts[makat] || 0) + Number(row.qty);
  });

  if(makatChart) makatChart.destroy();

  makatChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(counts),
      datasets: [{
        data: Object.values(counts),
        backgroundColor: [
          "#ff6384", "#36a2eb", "#ffcd56",
          "#4bc0c0", "#9966ff", "#ff9f40"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

// גרירת רוחב עמודות
function makeColumnsResizable(){
  const tables = document.querySelectorAll("table");
  tables.forEach(table => {
    const ths = table.querySelectorAll("th.resizable");
    ths.forEach(th => {
      th.onmousedown = function(e){
        if(e.offsetX > 10) return; // רק בקצה
        const startX = e.pageX;
        const startWidth = th.offsetWidth;

        function onMouseMove(ev){
          const newWidth = startWidth + (startX - ev.pageX);
          if(newWidth > 40){
            th.style.width = newWidth + "px";
          }
        }

        function onMouseUp(){
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        }

        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      };
    });
  });
}

// רענון
document.getElementById("refreshBtn").addEventListener("click", applyFilters);
</script>
</body>
</html>