<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>דשבורד מנהל – דו"ח תנועות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; background:#101820; color:#f5f5f5; margin:0; }
    header { padding:15px 20px; background:#1c2833; display:flex; justify-content:space-between; border-bottom:2px solid #263445; }
    header h1 { margin:0; font-size:22px; }
    #backBtn,#refreshBtn { background:#607d8b; color:white; border:none; padding:8px 14px; border-radius:8px; font-weight:bold; cursor:pointer; }
    main { padding:15px; }

    .filters { background:#17212b; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; flex-wrap:wrap; gap:8px; border:1px solid #263445; }
    .filters button { background:#263445; color:#f5f5f5; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .filters input[type="date"] { background:#101820; color:#f5f5f5; border:1px solid #455a64; border-radius:6px; padding:4px 6px; }

    .accordion-section { margin-bottom:10px; border-radius:10px; overflow:hidden; background:#17212b; border:1px solid #263445; }
    .accordion-header { padding:10px 12px; background:#1f2a36; cursor:pointer; display:flex; justify-content:space-between; font-weight:bold; }
    .accordion-header.open .arrow { transform:rotate(90deg); }
    .accordion-content { max-height:0; overflow:hidden; transition:max-height .25s ease; }
    .accordion-inner { padding:8px 10px; }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    thead { background:#263445; position:sticky; top:0; }
    th,td { padding:6px 4px; border-bottom:1px solid #263445; white-space:nowrap; }
    tbody tr:nth-child(even){ background:#1f2a36; }
    tbody tr:nth-child(odd){ background:#141c24; }

    .table-wrapper { max-height:320px; overflow:auto; border-radius:8px; border:1px solid #263445; }

    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-bottom:15px; }
    .card { background:#17212b; border-radius:10px; padding:10px; text-align:center; border:1px solid #263445; }
    .card-title { font-size:13px; color:#b0bec5; }
    .card-value { font-size:20px; font-weight:bold; color:#ffeb3b; }

    .loader { display:none; text-align:center; margin:15px 0; color:#ffeb3b; font-weight:bold; }
    .error { color:#ff5252; text-align:center; margin:10px 0; font-weight:bold; }

    #chartsSection { margin-top:40px; padding:20px; background:#17212b; border-radius:10px; border:1px solid #263445; }
  </style>
</head>

<body>

<header>
  <h1>דשבורד מנהל – דו"ח תנועות</h1>
  <div>
    <button id="refreshBtn">רענון</button>
    <button id="backBtn" onclick="goBack()">חזור</button>
  </div>
</header>

<main>

  <div class="filters">
    <div>
      <button onclick="setQuickRange('today')">היום</button>
      <button onclick="setQuickRange('week')">שבוע</button>
      <button onclick="setQuickRange('month')">חודש</button>
    </div>

    <div>
      <label>מתאריך:</label>
      <input type="date" id="fromDate" onchange="applyFilters()">
      <label>עד תאריך:</label>
      <input type="date" id="toDate" onchange="applyFilters()">
    </div>

    <div>
      <button onclick="setShift('morning')">משמרת בוקר</button>
      <button onclick="setShift('evening')">משמרת ערב</button>
    </div>
  </div>

  <div class="summary-cards">
    <div class="card"><div class="card-title">סה"כ דווחים</div><div class="card-value" id="totalReports">0</div></div>
    <div class="card"><div class="card-title">סה"כ משטחים</div><div class="card-value" id="totalPallets">0</div></div>
    <div class="card"><div class="card-title">סה"כ יחידות</div><div class="card-value" id="totalUnits">0</div></div>
    <div class="card"><div class="card-title">סה"כ עובדים</div><div class="card-value" id="totalWorkers">0</div></div>
  </div>

  <div class="loader" id="loader">טוען נתונים...</div>
  <div class="error" id="errorMsg"></div>

  <!-- טבלאות, אקורדיונים, גרפים — לא נוגעים -->

  <section id="chartsSection">
    <canvas id="makatPieChart"></canvas>
  </section>

</main>

<script>// חזרה אחורה
function goBack() { window.history.back(); }

// אקורדיון
function toggleAccordion(h){
  h.classList.toggle("open");
  const c=h.nextElementSibling;
  c.style.maxHeight = c.style.maxHeight ? null : c.scrollHeight+"px";
}

// טווחים מהירים
function setQuickRange(type){
  const t=new Date(); let f=new Date(), to=new Date();
  if(type==="week") f.setDate(t.getDate()-7);
  if(type==="month") f.setMonth(t.getMonth()-1);
  document.getElementById("fromDate").value=f.toISOString().split("T")[0];
  document.getElementById("toDate").value=to.toISOString().split("T")[0];
  applyFilters();
}

// משמרות
function setShift(s){
  const f=document.getElementById("fromDate").value;
  const t=document.getElementById("toDate").value;
  if(!f||!t){ alert("בחר טווח תאריכים"); return; }
  window.selectedShift = s==="morning" ? {startHour:6,endHour:14} : {startHour:14,endHour:22};
  applyFilters();
}

// טעינת נתונים
async function applyFilters(){
  const loader=document.getElementById("loader");
  const err=document.getElementById("errorMsg");
  loader.style.display="block"; err.textContent="";

  const f=document.getElementById("fromDate").value;
  const t=document.getElementById("toDate").value;
  if(!f||!t){ loader.style.display="none"; return; }

  try{
    const res=await fetch(
      `https://script.google.com/macros/s/AKfycbwJX4IaxmTmNx0re1ifoEPxgbsh6rAkFfmaehHDkJKW0LViqLtnkiCCg8uzsaA3PTtJEg/exec?from=${f}&to=${t}`
    );
    let data=await res.json();
    loader.style.display="none";

    if(!data.length){ err.textContent="לא נמצאו נתונים"; return; }

    // המרת תאריך ישראלי
    data.forEach(r=>{
      r._dateObj=new Date(r.date.split("/").reverse().join("-"));
    });

    processData(data);

  }catch(e){
    loader.style.display="none";
    err.textContent="שגיאה בטעינת הנתונים";
  }
}

// עיבוד נתונים
function processData(data){
  const sh=window.selectedShift;
  if(sh){
    data=data.filter(r=>{
      const h=Number(r.time.split(":")[0].padStart(2,"0"));
      return h>=sh.startHour && h<sh.endHour;
    });
  }

  fillSummary(data);
  fillByMakat(data);
  fillByWorker(data);
  fillByWarehouse(data);
  fillRawReports(data);
  fillAnomalies(data);
  drawPieChart(data);
}

// סיכום עליון
function fillSummary(data){
  document.getElementById("totalReports").textContent=data.length;
  const pallets=new Set(), workers=new Set(); let units=0;
  data.forEach(r=>{ pallets.add(r.pallet); units+=Number(r.qty); workers.add(r.worker); });
  document.getElementById("totalPallets").textContent=pallets.size;
  document.getElementById("totalUnits").textContent=units;
  document.getElementById("totalWorkers").textContent=workers.size;
}

// לפי מק"ט
function fillByMakat(data){
  const t=document.getElementById("tableByMakat"); t.innerHTML="";
  const g={};
  data.forEach(r=>{
    if(!g[r.makat]) g[r.makat]={pallets:new Set(),units:0,pkaot:new Set()};
    g[r.makat].pallets.add(r.pallet);
    g[r.makat].units+=Number(r.qty);
    g[r.makat].pkaot.add(r.pka);
  });

  Object.keys(g).forEach(m=>{
    const x=g[m];
    t.innerHTML+=`
      <tr>
        <td>${m}</td>
        <td>${x.pallets.size}</td>
        <td>${x.units}</td>
        <td>${x.pkaot.size}</td>
      </tr>`;
  });
}

// לפי עובדים
function fillByWorker(data){
  const t=document.getElementById("tableByWorker"); t.innerHTML="";
  const g={};
  data.forEach(r=>{
    if(!g[r.worker]) g[r.worker]={reports:0,pallets:new Set(),units:0};
    g[r.worker].reports++;
    g[r.worker].pallets.add(r.pallet);
    g[r.worker].units+=Number(r.qty);
  });

  Object.keys(g).forEach(w=>{
    const x=g[w];
    t.innerHTML+=`
      <tr>
        <td>${w}</td>
        <td>${x.reports}</td>
        <td>${x.pallets.size}</td>
        <td>${x.units}</td>
      </tr>`;
  });
}

// לפי מחסן
function fillByWarehouse(data){
  const t=document.getElementById("tableByWarehouse"); t.innerHTML="";
  const g={};
  data.forEach(r=>{
    const k=r.wh+"-"+r.subwh;
    if(!g[k]) g[k]={wh:r.wh,subwh:r.subwh,reports:0,pallets:new Set(),units:0};
    g[k].reports++;
    g[k].pallets.add(r.pallet);
    g[k].units+=Number(r.qty);
  });

  Object.values(g).forEach(x=>{
    t.innerHTML+=`
      <tr>
        <td>${x.wh}</td>
        <td>${x.subwh}</td>
        <td>${x.reports}</td>
        <td>${x.pallets.size}</td>
        <td>${x.units}</td>
      </tr>`;
  });
}

// גולמיים
function fillRawReports(data){
  const t=document.getElementById("tableRawReports"); t.innerHTML="";
  data.forEach(r=>{
    t.innerHTML+=`
      <tr>
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td>${r.worker}</td>
        <td>${r.makat}</td>
        <td>${r.pka}</td>
        <td>${r.qty}</td>
        <td>${r.pallet}</td>
        <td>${r.wh}</td>
        <td>${r.subwh}</td>
      </tr>`;
  });
}

// חריגות
function fillAnomalies(data){
  const t=document.getElementById("tableAnomalies"); t.innerHTML="";
  data.filter(r=>r.anomaly).forEach(r=>{
    t.innerHTML+=`
      <tr>
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td>${r.worker}</td>
        <td>${r.makat}</td>
        <td>${r.pka}</td>
        <td>${r.qty}</td>
        <td>${r.pallet}</td>
        <td>${r.wh}</td>
        <td>${r.subwh}</td>
        <td>${r.anomaly}</td>
      </tr>`;
  });
}

// גרף
let makatChart=null;
function drawPieChart(data){
  const ctx=document.getElementById("makatPieChart").getContext("2d");
  const c={};
  data.forEach(r=>{ c[r.makat]=(c[r.makat]||0)+Number(r.qty); });

  if(makatChart) makatChart.destroy();

  makatChart=new Chart(ctx,{
    type:"doughnut",
    data:{ labels:Object.keys(c), datasets:[{ data:Object.values(c),
      backgroundColor:["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff","#ff9f40"] }] },
    options:{ responsive:true, plugins:{ legend:{ position:"bottom" } } }
  });
}

document.getElementById("refreshBtn").addEventListener("click",applyFilters);

</script>
</body>
</html>