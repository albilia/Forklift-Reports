<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>דשבורד מנהל - דו"חות תוויות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="stylesheet" href="buttons.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #101820;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      direction: rtl;
    }

    header {
      padding: 15px 20px;
      background: #1c2833;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    #backBtn {
      background-color: #607d8b;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: bold;
    }

    main {
      padding: 15px;
    }

    .filters {
      background: #17212b;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters button {
      background: #263445;
      color: #f5f5f5;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
    }

    .filters button.active {
      background: #00c853;
      color: #fff;
    }

    .filters input[type="date"] {
      background: #101820;
      color: #f5f5f5;
      border: 1px solid #455a64;
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 13px;
    }

    .filters label {
      font-size: 13px;
      margin-inline-start: 4px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .card {
      background: #17212b;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }

    .card-title {
      font-size: 13px;
      color: #b0bec5;
      margin-bottom: 4px;
    }

    .card-value {
      font-size: 20px;
      font-weight: bold;
      color: #ffeb3b;
    }

    .accordion-section {
      margin-bottom: 10px;
      border-radius: 10px;
      overflow: hidden;
      background: #17212b;
    }

    .accordion-header {
      padding: 10px 12px;
      background: #1f2a36;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
    }

    .accordion-header span {
      pointer-events: none;
    }

    .accordion-header .arrow {
      transition: transform 0.2s ease;
    }

    .accordion-header.open .arrow {
      transform: rotate(90deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
      background: #17212b;
    }

    .accordion-inner {
      padding: 8px 10px 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #263445;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    th, td {
      padding: 6px 4px;
      text-align: right;
      border-bottom: 1px solid #263445;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #1f2a36;
    }

    tbody tr:nth-child(odd) {
      background: #141c24;
    }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #263445;
    }

    .loader {
      display: none;
      text-align: center;
      margin: 15px 0;
      font-weight: bold;
      color: #ffeb3b;
    }

    .error {
      color: #ff5252;
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
    }

    .info-line {
      font-size: 13px;
      color: #b0bec5;
      margin-bottom: 8px;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 18px;
      }
      .filters {
        flex-direction: column;
        align-items: flex-start;
      }
      th, td {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>דשבורד מנהל - דו"חות תוויות</h1>
  <button id="backBtn" onclick="goBack()">חזור</button>
</header>

<main>
  <div class="filters">
    <div>
      <button id="btnToday" onclick="setQuickRange('today')">היום</button>
      <button id="btnWeek" onclick="setQuickRange('week')">שבוע</button>
      <button id="btnMonth" onclick="setQuickRange('month')">חודש</button>
    </div>
    <div>
      <label>מתאריך:</label>
      <input type="date" id="fromDate" onchange="onDateChange()">
      <label>עד תאריך:</label>
      <input type="date" id="toDate" onchange="onDateChange()">
    </div>
    <div>
      <button id="btnShiftMorning" onclick="setShift('morning')">משמרת בוקר (06:30–18:30)</button>
      <button id="btnShiftEvening" onclick="setShift('evening')">משמרת ערב (18:30–06:30)</button>
    </div>
  </div>

  <div class="info-line" id="currentFilterInfo">
    טוען נתונים...
  </div>

  <div class="summary-cards">
    <div class="card">
      <div class="card-title">סה"כ דו"חות</div>
      <div class="card-value" id="totalReports">0</div>
    </div>
    <div class="card">
      <div class="card-title">סה"כ משטחים</div>
      <div class="card-value" id="totalPallets">0</div>
    </div>
    <div class="card">
      <div class="card-title">סה"כ יחידות</div>
      <div class="card-value" id="totalUnits">0</div>
    </div>
    <div class="card">
      <div class="card-title">סה"כ עובדים</div>
      <div class="card-value" id="totalWorkers">0</div>
    </div>
  </div>

  <div class="loader" id="loader">טוען נתונים מהשרת...</div>
  <div class="error" id="errorMsg"></div>

  <!-- סיכום לפי מק"ט -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מק"ט</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>מק"ט</th>
                <th>מס' משטחים</th>
                <th>סה"כ יחידות</th>
                <th>מס' פק"עים שונים</th>
              </tr>
            </thead>
            <tbody id="tableByMakat"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- סיכום לפי עובדים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי עובדים</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>עובד</th>
                <th>מס' דו"חות</th>
                <th>מס' משטחים</th>
                <th>סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWorker"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- סיכום לפי מחסן / תת־מחסן -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מחסן / תת־מחסן</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>מחסן</th>
                <th>תת־מחסן</th>
                <th>מס' דו"חות</th>
                <th>מס' משטחים</th>
                <th>סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWarehouse"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- דו"חות גולמיים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>דו"חות גולמיים (כל הדו"חות במשמרת)</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>שעה</th>
                <th>עובד</th>
                <th>מק"ט</th>
                <th>פק"ע</th>
                <th>כמות</th>
                <th>מס' משטח</th>
                <th>מחסן</th>
                <th>תת־מחסן</th>
              </tr>
            </thead>
            <tbody id="tableRawReports"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- חריגות (לדוגמה: כמות 0, נתונים חסרים וכו') -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>חריגות</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>שעה</th>
                <th>עובד</th>
                <th>מק"ט</th>
                <th>פק"ע</th>
                <th>כמות</th>
                <th>מס' משטח</th>
                <th>מחסן</th>
                <th>תת־מחסן</th>
                <th>סיבה</th>
              </tr>
            </thead>
            <tbody id="tableAnomalies"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwJX4IaxmTmNx0re1ifoEPxgbsh6rAkFfmaehHDkJKW0LViqLtnkiCCg8uzsaA3PTtJEg/exec";

  let allReports = [];
  let filteredReports = [];
  let currentShift = null; // 'morning' | 'evening' | null

  const loader = document.getElementById("loader");
  const errorMsg = document.getElementById("errorMsg");
  const infoLine = document.getElementById("currentFilterInfo");

  const totalReportsEl = document.getElementById("totalReports");
  const totalPalletsEl = document.getElementById("totalPallets");
  const totalUnitsEl = document.getElementById("totalUnits");
  const totalWorkersEl = document.getElementById("totalWorkers");

  const tableByMakat = document.getElementById("tableByMakat");
  const tableByWorker = document.getElementById("tableByWorker");
  const tableByWarehouse = document.getElementById("tableByWarehouse");
  const tableRawReports = document.getElementById("tableRawReports");
  const tableAnomalies = document.getElementById("tableAnomalies");

  const btnToday = document.getElementById("btnToday");
  const btnWeek = document.getElementById("btnWeek");
  const btnMonth = document.getElementById("btnMonth");
  const btnShiftMorning = document.getElementById("btnShiftMorning");
  const btnShiftEvening = document.getElementById("btnShiftEvening");
  const fromDateInput = document.getElementById("fromDate");
  const toDateInput = document.getElementById("toDate");

  function goBack() {
    window.location.href = "dashboard.html";
  }

  function toggleAccordion(headerEl) {
    const content = headerEl.nextElementSibling;
    const arrow = headerEl.querySelector(".arrow");
    const isOpen = headerEl.classList.contains("open");

    if (isOpen) {
      headerEl.classList.remove("open");
      content.style.maxHeight = 0;
    } else {
      headerEl.classList.add("open");
      content.style.maxHeight = content.scrollHeight + "px";
    }
  }

  function setQuickRange(type) {
    clearQuickButtons();
    currentShift = null;
    btnShiftMorning.classList.remove("active");
    btnShiftEvening.classList.remove("active");

    const today = new Date();
    let from, to;

    if (type === "today") {
      btnToday.classList.add("active");
      from = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      to = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    } else if (type === "week") {
      btnWeek.classList.add("active");
      to = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      from = new Date(to);
      from.setDate(from.getDate() - 6);
    } else if (type === "month") {
      btnMonth.classList.add("active");
      to = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      from = new Date(to);
      from.setDate(from.getDate() - 29);
    }

    fromDateInput.value = formatDateInput(from);
    toDateInput.value = formatDateInput(to);

    applyFilters();
  }

  function clearQuickButtons() {
    btnToday.classList.remove("active");
    btnWeek.classList.remove("active");
    btnMonth.classList.remove("active");
  }

  function setShift(shift) {
    currentShift = shift;
    btnShiftMorning.classList.toggle("active", shift === "morning");
    btnShiftEvening.classList.toggle("active", shift === "evening");
    applyFilters();
  }

  function onDateChange() {
    clearQuickButtons();
    applyFilters();
  }

  function formatDateInput(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function parseReportDate(dateStr) {
    const parts = dateStr.split("/");
    if (parts.length !== 3) return null;
    const d = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10) - 1;
    const y = parseInt(parts[2], 10);
    return new Date(2000 + y, m, d);
  }

  function parseReportTime(timeStr) {
    const parts = timeStr.split(":");
    if (parts.length !== 2) return null;
    const h = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    return { h, m };
  }

  function isInShift(report) {
    if (!currentShift) return true;

    const t = parseReportTime(report.time || report.hour || "");
    if (!t) return true;

    const minutes = t.h * 60 + t.m;

    const morningStart = 6 * 60 + 30;
    const morningEnd = 18 * 60 + 30;
    const eveningStart = 18 * 60 + 30;
    const eveningEnd = 6 * 60 + 30;

    if (currentShift === "morning") {
      return minutes >= morningStart && minutes <= morningEnd;
    } else if (currentShift === "evening") {
      return minutes >= eveningStart || minutes <= eveningEnd;
    }
    return true;
  }

  function applyFilters() {
    if (!allReports.length) return;

    const fromVal = fromDateInput.value;
    const toVal = toDateInput.value;

    let fromDate = null;
    let toDate = null;

    if (fromVal) {
      const [y, m, d] = fromVal.split("-");
      fromDate = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    }
    if (toVal) {
      const [y, m, d] = toVal.split("-");
      toDate = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    }

    filteredReports = allReports.filter(r => {
      const d = parseReportDate(r.date || r.reportDate || "");
      if (!d) return false;

      if (fromDate && d < fromDate) return false;
      if (toDate && d > toDate) return false;

      if (!isInShift(r)) return false;

      return true;
    });

    updateInfoLine();
    updateSummary();
    buildTables();
  }

  function updateInfoLine() {
    const fromVal = fromDateInput.value;
    const toVal = toDateInput.value;

    let text = "טווח נוכחי: ";

    if (fromVal && toVal) {
      text += `מ-${formatDateDisplay(fromVal)} עד ${formatDateDisplay(toVal)}`;
    } else if (fromVal) {
      text += `מ-${formatDateDisplay(fromVal)}`;
    } else if (toVal) {
      text += `עד ${formatDateDisplay(toVal)}`;
    } else {
      text += "כל הזמנים";
    }

    if (currentShift === "morning") {
      text += " | משמרת בוקר (06:30–18:30)";
    } else if (currentShift === "evening") {
      text += " | משמרת ערב (18:30–06:30)";
    }

    text += ` | סה"כ דו"חות: ${filteredReports.length}`;

    infoLine.innerText = text;
  }

  function formatDateDisplay(inputVal) {
    const [y, m, d] = inputVal.split("-");
    return `${d}/${m}/${y.slice(-2)}`;
  }

  function updateSummary() {
    totalReportsEl.innerText = filteredReports.length;

    const palletSet = new Set();
    let totalUnits = 0;
    const workerSet = new Set();

    filteredReports.forEach(r => {
      const palletId = r.palletId || r.pallet || r.palletNum || "";
      if (palletId) {
        palletSet.add(`${r.makat || r.makatNum || ""}#${palletId}`);
      }
      const qty = Number(r.qty || r.quantity || 0);
      if (!isNaN(qty)) totalUnits += qty;

      const worker = r.name || r.worker || "";
      if (worker) workerSet.add(worker);
    });

    totalPalletsEl.innerText = palletSet.size;
    totalUnitsEl.innerText = totalUnits;
    totalWorkersEl.innerText = workerSet.size;
  }

  function buildTables() {
    buildTableByMakat();
    buildTableByWorker();
    buildTableByWarehouse();
    buildTableRawReports();
    buildTableAnomalies();
  }

  function buildTableByMakat() {
    tableByMakat.innerHTML = "";
    const map = new Map();

    filteredReports.forEach(r => {
      const makat = r.makat || r.makatNum || "---";
      const key = makat;
      if (!map.has(key)) {
        map.set(key, {
          makat,
          pallets: new Set(),
          totalQty: 0,
          pkaSet: new Set()
        });
      }
      const obj = map.get(key);
      const palletId = r.palletId || r.pallet || r.palletNum || "";
      if (palletId) obj.pallets.add(palletId);
      const qty = Number(r.qty || r.quantity || 0);
      if (!isNaN(qty)) obj.totalQty += qty;
      const pka = r.pka || r.batch || "";
      if (pka) obj.pkaSet.add(pka);
    });

    Array.from(map.values()).forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.makat}</td>
        <td>${row.pallets.size}</td>
        <td>${row.totalQty}</td>
        <td>${row.pkaSet.size}</td>
      `;
      tableByMakat.appendChild(tr);
    });
  }

  function buildTableByWorker() {
    tableByWorker.innerHTML = "";
    const map = new Map();

    filteredReports.forEach(r => {
      const worker = r.name || r.worker || "לא ידוע";
      if (!map.has(worker)) {
        map.set(worker, {
          worker,
          reportsCount: 0,
          pallets: new Set(),
          totalQty: 0
        });
      }
      const obj = map.get(worker);
      obj.reportsCount++;
      const palletId = r.palletId || r.pallet || r.palletNum || "";
      if (palletId) obj.pallets.add(`${r.makat || ""}#${palletId}`);
      const qty = Number(r.qty || r.quantity || 0);
      if (!isNaN(qty)) obj.totalQty += qty;
    });

    Array.from(map.values()).forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.worker}</td>
        <td>${row.reportsCount}</td>
        <td>${row.pallets.size}</td>
        <td>${row.totalQty}</td>
      `;
      tableByWorker.appendChild(tr);
    });
  }

  function buildTableByWarehouse() {
    tableByWarehouse.innerHTML = "";
    const map = new Map();

    filteredReports.forEach(r => {
      const main = r.main || r.warehouse || "";
      const finished = r.finished || r.sub || r.subWarehouse || "";
      const key = main + "||" + finished;

      if (!map.has(key)) {
        map.set(key, {
          main,
          finished,
          reportsCount: 0,
          pallets: new Set(),
          totalQty: 0
        });
      }
      const obj = map.get(key);
      obj.reportsCount++;
      const palletId = r.palletId || r.pallet || r.palletNum || "";
      if (palletId) obj.pallets.add(`${r.makat || ""}#${palletId}`);
      const qty = Number(r.qty || r.quantity || 0);
      if (!isNaN(qty)) obj.totalQty += qty;
    });

    Array.from(map.values()).forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.main || ""}</td>
        <td>${row.finished || ""}</td>
        <td>${row.reportsCount}</td>
        <td>${row.pallets.size}</td>
        <td>${row.totalQty}</td>
      `;
      tableByWarehouse.appendChild(tr);
    });
  }

  function buildTableRawReports() {
    tableRawReports.innerHTML = "";

    filteredReports
      .slice()
      .sort((a, b) => {
        const da = parseReportDate(a.date || "");
        const db = parseReportDate(b.date || "");
        if (da && db && da.getTime() !== db.getTime()) {
          return da - db;
        }
        const ta = a.time || "";
        const tb = b.time || "";
        return ta.localeCompare(tb);
      })
      .forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.time || ""}</td>
          <td>${r.name || ""}</td>
          <td>${r.makat || ""}</td>
          <td>${r.pka || ""}</td>
          <td>${r.qty || ""}</td>
          <td>${r.palletId || r.pallet || ""}</td>
          <td>${r.main || r.warehouse || ""}</td>
          <td>${r.finished || r.sub || ""}</td>
        `;
        tableRawReports.appendChild(tr);
      });
  }

  function buildTableAnomalies() {
    tableAnomalies.innerHTML = "";

    filteredReports.forEach(r => {
      const qty = Number(r.qty || r.quantity || 0);
      let reason = "";

      if (isNaN(qty) || qty <= 0) {
        reason = "כמות לא תקינה";
      } else if (!r.makat) {
        reason = "מק\"ט חסר";
      } else if (!r.pka) {
        reason = "פק\"ע חסר";
      }

      if (!reason) return;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.date || ""}</td>
        <td>${r.time || ""}</td>
        <td>${r.name || ""}</td>
        <td>${r.makat || ""}</td>
        <td>${r.pka || ""}</td>
        <td>${r.qty || ""}</td>
        <td>${r.palletId || r.pallet || ""}</td>
        <td>${r.main || r.warehouse || ""}</td>
        <td>${r.finished || r.sub || ""}</td>
        <td>${reason}</td>
      `;
      tableAnomalies.appendChild(tr);
    });
  }

  async function loadReports() {
    loader.style.display = "block";
    errorMsg.innerText = "";
    infoLine.innerText = "טוען נתונים...";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "getReports"
        })
      });

      const data = await res.json();

      if (!data || !data.success || !Array.isArray(data.reports)) {
        throw new Error("מבנה נתונים לא תקין מהשרת");
      }

      allReports = data.reports;
      if (!allReports.length) {
        infoLine.innerText = "אין דו\"חות להצגה.";
        filteredReports = [];
        updateSummary();
        buildTables();
        return;
      }

      const dates = allReports
        .map(r => parseReportDate(r.date || ""))
        .filter(d => d instanceof Date && !isNaN(d.getTime()))
        .sort((a, b) => a - b);

      if (dates.length) {
        const from = dates[0];
        const to = dates[dates.length - 1];
        fromDateInput.value = formatDateInput(from);
        toDateInput.value = formatDateInput(to);
      }

      applyFilters();
    } catch (e) {
      console.error(e);
      errorMsg.innerText = "שגיאה בטעינת הנתונים: " + e.message;
      infoLine.innerText = "לא ניתן להציג נתונים.";
    } finally {
      loader.style.display = "none";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadReports();
  });
</script>

</body>
</html>
