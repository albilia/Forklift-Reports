<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>דשבורד מנהל – דו"ח תנועות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; background:#101820; color:#f5f5f5; margin:0; }
    header { padding:15px 20px; background:#1c2833; display:flex; justify-content:space-between; border-bottom:2px solid #263445; }
    header h1 { margin:0; font-size:22px; }
    #backBtn,#refreshBtn { background:#607d8b; color:white; border:none; padding:8px 14px; border-radius:8px; font-weight:bold; cursor:pointer; }
    main { padding:15px; }

    .filters { background:#17212b; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; flex-wrap:wrap; gap:8px; border:1px solid #263445; }
    .filters button { background:#263445; color:#f5f5f5; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .filters input[type="date"] { background:#101820; color:#f5f5f5; border:1px solid #455a64; border-radius:6px; padding:4px 6px; }

    .accordion-section { margin-bottom:10px; border-radius:10px; overflow:hidden; background:#17212b; border:1px solid #263445; }
    .accordion-header { padding:10px 12px; background:#1f2a36; cursor:pointer; display:flex; justify-content:space-between; font-weight:bold; }
    .accordion-header.open .arrow { transform:rotate(90deg); }
    .accordion-content { max-height:0; overflow:hidden; transition:max-height .25s ease; }
    .accordion-inner { padding:8px 10px; }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    thead { background:#263445; position:sticky; top:0; }
    th,td { padding:6px 4px; border-bottom:1px solid #263445; white-space:nowrap; }
    tbody tr:nth-child(even){ background:#1f2a36; }
    tbody tr:nth-child(odd){ background:#141c24; }

    .table-wrapper { max-height:320px; overflow:auto; border-radius:8px; border:1px solid #263445; }

    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-bottom:15px; }
    .card { background:#17212b; border-radius:10px; padding:10px; text-align:center; border:1px solid #263445; }
    .card-title { font-size:13px; color:#b0bec5; }
    .card-value { font-size:20px; font-weight:bold; color:#ffeb3b; }

    .loader { display:none; text-align:center; margin:15px 0; color:#ffeb3b; font-weight:bold; }
    .error { color:#ff5252; text-align:center; margin:10px 0; font-weight:bold; }

    #chartsSection { margin-top:40px; padding:20px; background:#17212b; border-radius:10px; border:1px solid #263445; }
  </style>
</head>

<body>

<header>
  <h1>דשבורד מנהל – דו"ח תנועות</h1>
  <div>
    <button id="refreshBtn">רענון</button>
    <button id="backBtn" onclick="goBack()">חזור</button>
  </div>
</header>

<main>

  <div class="filters">
    <div>
      <button onclick="setQuickRange('today')">היום</button>
      <button onclick="setQuickRange('week')">שבוע</button>
      <button onclick="setQuickRange('month')">חודש</button>
    </div>

    <div>
      <label>מתאריך:</label>
      <input type="date" id="fromDate" onchange="applyFilters()">
      <label>עד תאריך:</label>
      <input type="date" id="toDate" onchange="applyFilters()">
    </div>

    <div>
      <button onclick="setShift('morning')">משמרת בוקר</button>
      <button onclick="setShift('evening')">משמרת ערב</button>
    </div>
  </div>

  <div class="summary-cards">
    <div class="card"><div class="card-title">סה"כ דווחים</div><div class="card-value" id="totalReports">0</div></div>
    <div class="card"><div class="card-title">סה"כ משטחים</div><div class="card-value" id="totalPallets">0</div></div>
    <div class="card"><div class="card-title">סה"כ יחידות</div><div class="card-value" id="totalUnits">0</div></div>
    <div class="card"><div class="card-title">סה"כ עובדים</div><div class="card-value" id="totalWorkers">0</div></div>
  </div>

  <div class="loader" id="loader">טוען נתונים...</div>
  <div class="error" id="errorMsg"></div>

  <!-- אקורדיון: סיכום לפי מק"ט -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מק"ט</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>מק"ט</th>
                <th>מס' משטחים</th>
                <th>סה"כ יחידות</th>
                <th>מס' פק"עים שונים</th>
              </tr>
            </thead>
            <tbody id="tableByMakat"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: סיכום לפי עובדים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי עובדים</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>עובד</th>
                <th>דווחים</th>
                <th>משטחים</th>
                <th>סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWorker"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: סיכום לפי מחסן -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>סיכום לפי מחסן</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>מחסן</th>
                <th>תת־מחסן</th>
                <th>דווחים</th>
                <th>משטחים</th>
                <th>סה"כ יחידות</th>
              </tr>
            </thead>
            <tbody id="tableByWarehouse"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: דווחים גולמיים -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>דווחים גולמיים</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>שעה</th>
                <th>עובד</th>
                <th>מק"ט</th>
                <th>פק"ע</th>
                <th>כמות</th>
                <th>משטח</th>
                <th>מחסן</th>
                <th>תת־מחסן</th>
              </tr>
            </thead>
            <tbody id="tableRawReports"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- אקורדיון: חריגות -->
  <div class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      <span>חריגות</span>
      <span class="arrow">▶</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>שעה</th>
                <th>עובד</th>
                <th>מק"ט</th>
                <th>פק"ע</th>
                <th>כמות</th>
                <th>משטח</th>
                <th>מחסן</th>
                <th>תת־מחסן</th>
                <th>סיבה</th>
              </tr>
            </thead>
            <tbody id="tableAnomalies"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <section id="chartsSection">
    <canvas id="makatPieChart"></canvas>
  </section>

</main>

<script>// חזרה אחורה
function goBack() { 
  window.history.back(); 
}

// אקורדיון
function toggleAccordion(header){
  header.classList.toggle("open");
  const content = header.nextElementSibling;
  content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
}

// טווחים מהירים
function setQuickRange(type){
  const today = new Date();
  let from = new Date();
  let to = new Date();

  if(type === "week") from.setDate(today.getDate() - 7);
  if(type === "month") from.setMonth(today.getMonth() - 1);

  document.getElementById("fromDate").value = from.toISOString().split("T")[0];
  document.getElementById("toDate").value = to.toISOString().split("T")[0];

  applyFilters();
}

// משמרות
function setShift(shift){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if(!from || !to){
    alert("בחר טווח תאריכים לפני בחירת משמרת");
    return;
  }

  window.selectedShift = 
    shift === "morning" 
      ? { startHour: 6, endHour: 14 } 
      : { startHour: 14, endHour: 22 };

  applyFilters();
}

// טעינת נתונים
async function applyFilters(){
  const loader = document.getElementById("loader");
  const errorMsg = document.getElementById("errorMsg");

  loader.style.display = "block";
  errorMsg.textContent = "";

  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if(!from || !to){
    loader.style.display = "none";
    return;
  }

  try{
    const response = await fetch(
      `https://script.google.com/macros/s/AKfycbwJX4IaxmTmNx0re1ifoEPxgbsh6rAkFfmaehHDkJKW0LViqLtnkiCCg8uzsaA3PTtJEg/exec?from=${from}&to=${to}`
    );

    let data = await response.json();
    loader.style.display = "none";

    if(!data.length){
      errorMsg.textContent = "לא נמצאו נתונים";
      return;
    }

    // המרת תאריך ישראלי ל־Date
    data.forEach(r => {
      r._dateObj = new Date(r.date.split("/").reverse().join("-"));
    });

    processData(data);

  } catch(err){
    loader.style.display = "none";
    errorMsg.textContent = "שגיאה בטעינת הנתונים";
  }
}

// עיבוד נתונים
function processData(data){
  const shift = window.selectedShift;

  if(shift){
    data = data.filter(row => {
      const hour = Number(row.time.split(":")[0].padStart(2, "0"));
      return hour >= shift.startHour && hour < shift.endHour;
    });
  }

  fillSummary(data);
  fillByMakat(data);
  fillByWorker(data);
  fillByWarehouse(data);
  fillRawReports(data);
  fillAnomalies(data);
  drawPieChart(data);
}

// סיכום עליון
function fillSummary(data){
  document.getElementById("totalReports").textContent = data.length;

  const pallets = new Set();
  const workers = new Set();
  let units = 0;

  data.forEach(row => {
    pallets.add(row.pallet);
    workers.add(row.worker);
    units += Number(row.qty);
  });

  document.getElementById("totalPallets").textContent = pallets.size;
  document.getElementById("totalUnits").textContent = units;
  document.getElementById("totalWorkers").textContent = workers.size;
}

// סיכום לפי מק"ט
function fillByMakat(data){
  const table = document.getElementById("tableByMakat");
  table.innerHTML = "";

  const grouped = {};

  data.forEach(row => {
    if(!grouped[row.makat]){
      grouped[row.makat] = {
        pallets: new Set(),
        units: 0,
        pkaot: new Set()
      };
    }

    grouped[row.makat].pallets.add(row.pallet);
    grouped[row.makat].units += Number(row.qty);
    grouped[row.makat].pkaot.add(row.pka);
  });

  Object.keys(grouped).forEach(makat => {
    const g = grouped[makat];

    table.innerHTML += `
      <tr>
        <td>${makat}</td>
        <td>${g.pallets.size}</td>
        <td>${g.units}</td>
        <td>${g.pkaot.size}</td>
      </tr>
    `;
  });
}// סיכום לפי מחסן
function fillByWarehouse(data){
  const table = document.getElementById("tableByWarehouse");
  table.innerHTML = "";

  const grouped = {};

  data.forEach(row => {
    const key = row.wh + "-" + row.subwh;

    if(!grouped[key]){
      grouped[key] = {
        wh: row.wh,
        subwh: row.subwh,
        reports: 0,
        pallets: new Set(),
        units: 0
      };
    }

    grouped[key].reports++;
    grouped[key].pallets.add(row.pallet);
    grouped[key].units += Number(row.qty);
  });

  Object.values(grouped).forEach(g => {
    table.innerHTML += `
      <tr>
        <td>${g.wh}</td>
        <td>${g.subwh}</td>
        <td>${g.reports}</td>
        <td>${g.pallets.size}</td>
        <td>${g.units}</td>
      </tr>
    `;
  });
}

// דווחים גולמיים
function fillRawReports(data){
  const table = document.getElementById("tableRawReports");
  table.innerHTML = "";

  data.forEach(row => {
    table.innerHTML += `
      <tr>
        <td>${row.date}</td>
        <td>${row.time}</td>
        <td>${row.worker}</td>
        <td>${row.makat}</td>
        <td>${row.pka}</td>
        <td>${row.qty}</td>
        <td>${row.pallet}</td>
        <td>${row.wh}</td>
        <td>${row.subwh}</td>
      </tr>
    `;
  });
}

// חריגות
function fillAnomalies(data){
  const table = document.getElementById("tableAnomalies");
  table.innerHTML = "";

  data.filter(row => row.anomaly).forEach(row => {
    table.innerHTML += `
      <tr>
        <td>${row.date}</td>
        <td>${row.time}</td>
        <td>${row.worker}</td>
        <td>${row.makat}</td>
        <td>${row.pka}</td>
        <td>${row.qty}</td>
        <td>${row.pallet}</td>
        <td>${row.wh}</td>
        <td>${row.subwh}</td>
        <td>${row.anomaly}</td>
      </tr>
    `;
  });
}

// גרף דונאט
let makatChart = null;

function drawPieChart(data){
  const ctx = document.getElementById("makatPieChart").getContext("2d");

  const counts = {};
  data.forEach(row => {
    counts[row.makat] = (counts[row.makat] || 0) + Number(row.qty);
  });

  if(makatChart) makatChart.destroy();

  makatChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(counts),
      datasets: [{
        data: Object.values(counts),
        backgroundColor: [
          "#ff6384", "#36a2eb", "#ffcd56",
          "#4bc0c0", "#9966ff", "#ff9f40"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

// רענון
document.getElementById("refreshBtn").addEventListener("click", applyFilters);

</script>
</body>
</html>