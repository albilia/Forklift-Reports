<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0">
  <title>היסטוריית דווחים</title>

  <link rel="stylesheet" href="menu.css">
  <link rel="stylesheet" href="buttons.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100%;
      overflow-x: hidden;
      overscroll-behavior-y: none;
      background: #111 url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #f5f5f5;
      font-family: Arial, sans-serif;
    }

    body {
      position: relative;
    }

    .top-bar {
      background: rgba(0,0,0,0.55);
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
    }

    .title {
      font-size: 26px;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
    }

    .content {
      padding: 15px;
    }

    .filters {
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .filters .field {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    .filters label {
      font-size: 13px;
      margin-bottom: 3px;
    }

    .filters input {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .filters button {
      font-size: 14px !important;
      padding: 8px 12px !important;
      width: auto;
      max-width: none;
      margin: 0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .filters button.main { background:#1e88e5; color:#fff; }
    .filters button.secondary { background:#ffca28; color:#000; }
    .filters button.neutral { background:#607d8b; color:#fff; }
    .filters button.today { background:#43a047; color:#fff; }
    .filters button.refresh { background:#8e24aa; color:#fff; }

    #summaryBar {
      background: rgba(0,0,0,0.7);
      border-radius: 10px;
      padding: 8px 12px;
      margin-bottom: 10px;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    #summaryBar span { white-space: nowrap; }

    #loading {
      margin: 5px 0;
      font-size: 14px;
      color: #ffeb3b;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: rgba(0,0,0,0.7);
      border-radius: 10px;
      overflow: hidden;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #555;
      padding: 6px;
      font-size: 13px;
      text-align: center;
    }

    th {
      background: rgba(0,0,0,0.9);
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    th.sort-asc::after { content: " ▲"; font-size: 10px; }
    th.sort-desc::after { content: " ▼"; font-size: 10px; }

    @media (max-width: 768px) {
      table { font-size: 11px; }
    }
  </style>
</head>

<body>
  <div id="menuContainer"></div>

  <div class="top-bar">
    <div class="title">היסטוריית דווחים</div>
  </div>

  <div class="content">

    <div class="filters">
      <div class="field">
        <label>תאריך התחלה:</label>
        <input type="date" id="startDate">
      </div>
      <div class="field">
        <label>תאריך סיום:</label>
        <input type="date" id="endDate">
      </div>
      <div class="field" style="flex:1;">
        <label>חיפוש חכם (מק״ט / פק״ע / עובד / תת־מחסן):</label>
        <input type="text" id="searchInput" placeholder="הקלד כדי לסנן בזמן אמת">
      </div>
      <button class="main" onclick="loadHistory()">טען דווחים</button>
      <button class="today" onclick="loadToday()">היסטוריה מהיום</button>
      <button class="refresh" onclick="refreshView()">רענן</button>
      <button class="secondary" onclick="exportCsv()">ייצוא לאקסל</button>
      <button class="neutral" onclick="goBack()">חזור לדשבורד</button>
    </div>

    <div id="summaryBar">
      <span id="sumCount">סה״כ דיווחים: 0</span>
      <span id="sumPallets">סה״כ משטחים: 0</span>
    </div>

    <div id="loading" style="display:none;">טוען נתונים...</div>

    <table id="historyTable">
      <thead>
        <tr>
          <th data-sort="date">תאריך</th>
          <th data-sort="time">שעה</th>
          <th data-sort="worker">עובד</th>
          <th>פירוט תוויות</th>
          <th data-sort="totalQty">סה״כ</th>
          <th data-sort="warehouse">מחסן</th>
          <th data-sort="subWarehouse">תת־מחסן</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxzNj0wvC-Tb5wquuuAWvOfkxf_H4YRKzl3vijRlyi2nvkkH8VgDcL438RBKg5QeanrTg/exec";

  const params = new URLSearchParams(window.location.search);
  const phone = params.get("phone");
  const name = params.get("name");

  function goBack() {
    window.location.href = `dashboard.html?phone=${encodeURIComponent(phone)}&name=${encodeURIComponent(name)}`;
  }

  let allRows = [];
  let filteredRows = [];
  let currentSort = { field: null, dir: 1 };

  function formatDateTime(isoString, type) {
    if (!isoString) return "";
    try {
      const date = new Date(isoString);
      if (type === "date") {
        return date.toLocaleDateString("he-IL", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
      }
      if (type === "time") {
        return date.toLocaleTimeString("he-IL", {
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    } catch {
      return "";
    }
  }

  function parseDate(d) {
    if (!d) return null;
    const parts = d.toString().trim().split("/");
    if (parts.length !== 3) return null;
    const [day, month, year] = parts;
    return new Date(Number(year), Number(month) - 1, Number(day));
  }

  function groupByShot(rows) {
    const grouped = {};

    rows.forEach(r => {
      const key = `${r.date}|${r.time}|${r.worker}|${r.subWarehouse}|${r.warehouse}`;

      if (!grouped[key]) {
        grouped[key] = {
          date: r.date,
          time: r.time,
          worker: r.worker,
          subWarehouse: r.subWarehouse,
          warehouse: r.warehouse,
          labels: [],
          rowIndexes: []
        };
      }

      grouped[key].labels.push({
        makat: r.makat,
        pka: r.pka,
        qty: r.qty,
        rowIndex: r.rowIndex
      });
      grouped[key].rowIndexes.push(r.rowIndex);
    });

    return Object.values(grouped);
  }

  async function loadHistory() {
    document.getElementById("loading").style.display = "block";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getHistory" })
      });

      const data = await res.json();
      if (!data.success) {
        alert("שגיאה בטעינת היסטוריה");
        return;
      }

      allRows = data.rows || [];
      applyFiltersAndRender();

    } catch (e) {
      alert("שגיאה בטעינת נתונים");
    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  function loadToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const iso = `${yyyy}-${mm}-${dd}`;
    document.getElementById("startDate").value = iso;
    document.getElementById("endDate").value = iso;
    applyFiltersAndRender();
  }

  function refreshView() {
    applyFiltersAndRender();
  }  function applyFiltersAndRender() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const search = document.getElementById("searchInput").value.trim().toLowerCase();

    filteredRows = allRows.filter(r => {
      if (start || end) {
        const rowDateObj = parseDate(r.date);
        const startDateObj = start ? new Date(start) : null;
        const endDateObj = end ? new Date(end) : null;

        if (rowDateObj) {
          if (startDateObj && rowDateObj < startDateObj) return false;
          if (endDateObj && rowDateObj > endDateObj) return false;
        }
      }

      if (search) {
        const hay = [
          r.makat,
          r.pka,
          r.worker,
          r.subWarehouse,
          r.warehouse
        ].map(x => (x || "").toString().toLowerCase()).join(" ");
        if (!hay.includes(search)) return false;
      }

      return true;
    });

    if (currentSort.field) {
      sortRows(currentSort.field, currentSort.dir, false);
    } else {
      renderDesktop(filteredRows);
      updateSummary(filteredRows);
    }
  }

  function sortRows(field, dir, toggle = true) {
    if (toggle) {
      if (currentSort.field === field) {
        currentSort.dir = -currentSort.dir;
      } else {
        currentSort.field = field;
        currentSort.dir = 1;
      }
      dir = currentSort.dir;
    }

    filteredRows.sort((a, b) => {
      let va = a[field];
      let vb = b[field];

      if (field === "date") {
        const da = parseDate(va)?.getTime() || 0;
        const db = parseDate(vb)?.getTime() || 0;
        return (da - db) * dir;
      }

      if (field === "time") {
        const da = va ? new Date(`1970-01-01T${va}`).getTime() : 0;
        const db = vb ? new Date(`1970-01-01T${vb}`).getTime() : 0;
        return (da - db) * dir;
      }

      const na = parseFloat(va);
      const nb = parseFloat(vb);
      if (!isNaN(na) && !isNaN(nb)) {
        return (na - nb) * dir;
      }

      va = (va || "").toString().toLowerCase();
      vb = (vb || "").toString().toLowerCase();
      if (va < vb) return -1 * dir;
      if (va > vb) return 1 * dir;
      return 0;
    });

    updateSortHeaders();
    renderDesktop(filteredRows);
    updateSummary(filteredRows);
  }

  function updateSortHeaders() {
    const ths = document.querySelectorAll("#historyTable thead th[data-sort]");
    ths.forEach(th => {
      th.classList.remove("sort-asc", "sort-desc");
      const field = th.getAttribute("data-sort");
      if (field && field === currentSort.field) {
        th.classList.add(currentSort.dir === 1 ? "sort-asc" : "sort-desc");
      }
    });
  }

  function updateSummary(rows) {
    const grouped = groupByShot(rows);
    document.getElementById("sumCount").textContent = "סה״כ דיווחים: " + grouped.length;
    document.getElementById("sumPallets").textContent = "סה״כ משטחים: " + grouped.length;
  }

  function renderDesktop(rows) {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    const groupedRows = groupByShot(rows);

    groupedRows.forEach((group, gIdx) => {
      const tr = document.createElement("tr");

      const labelLines = group.labels.map((l, i) => `
        <div style="margin-bottom:6px; text-align:right;">
          מק״ט:
          <input id="makat-${gIdx}-${i}" value="${l.makat || ""}"
            oninput="handleLabelChange(${gIdx}, ${i})" style="width:90px;">
          פק״ע:
          <input id="pka-${gIdx}-${i}" value="${l.pka || ""}"
            oninput="handleLabelChange(${gIdx}, ${i})" style="width:60px;">
          כמות:
          <input id="qty-${gIdx}-${i}" value="${l.qty || ""}"
            oninput="handleLabelChange(${gIdx}, ${i})" style="width:60px;">

          <button id="save-label-${gIdx}-${i}"
            onclick="saveLabelEdit(${gIdx}, ${i})"
            style="padding:2px 6px; font-size:11px; display:none;">
            שמור
          </button>
        </div>
      `).join("");

      const totalQty = group.labels.reduce((sum, l) => sum + Number(l.qty || 0), 0);

      tr.innerHTML = `
        <td>${formatDateTime(group.date, "date")}</td>
        <td>${formatDateTime(group.time, "time")}</td>
        <td>${group.worker || ""}</td>
        <td>${labelLines}</td>
        <td>${totalQty}</td>
        <td>${group.warehouse || ""}</td>
        <td>${group.subWarehouse || ""}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  function handleLabelChange(groupIndex, labelIndex) {
    const grouped = groupByShot(filteredRows);
    const group = grouped[groupIndex];
    const label = group.labels[labelIndex];

    const newMakat = document.getElementById(`makat-${groupIndex}-${labelIndex}`).value.trim();
    const newPka = document.getElementById(`pka-${groupIndex}-${labelIndex}`).value.trim();
    const newQty = document.getElementById(`qty-${groupIndex}-${labelIndex}`).value.trim();

    const changed =
      newMakat !== (label.makat || "") ||
      newPka !== (label.pka || "") ||
      newQty !== String(label.qty || "");

    const btn = document.getElementById(`save-label-${groupIndex}-${labelIndex}`);
    if (btn) {
      btn.style.display = changed ? "inline-block" : "none";
    }
  }

  async function saveLabelEdit(groupIndex, labelIndex) {
    const grouped = groupByShot(filteredRows);
    const group = grouped[groupIndex];
    const label = group.labels[labelIndex];

    const newMakat = document.getElementById(`makat-${groupIndex}-${labelIndex}`).value.trim();
    const newPka = document.getElementById(`pka-${groupIndex}-${labelIndex}`).value.trim();
    const newQty = document.getElementById(`qty-${groupIndex}-${labelIndex}`).value.trim();

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "updateLabel",
          rowIndex: label.rowIndex,
          newMakat,
          newPka,
          newQty
        })
      });

      const data = await res.json();
      if (data.success) {
        const btn = document.getElementById(`save-label-${groupIndex}-${labelIndex}`);
        if (btn) btn.style.display = "none";
        await loadHistory();
      } else {
        alert("שגיאה בעדכון");
      }

    } catch (e) {
      alert("שגיאה בחיבור");
    }
  }

  function exportCsv() {
    if (!filteredRows || filteredRows.length === 0) {
      alert("אין נתונים לייצוא");
      return;
    }

    const grouped = groupByShot(filteredRows);
    const headers = ["תאריך","שעה","עובד","פירוט תוויות","סה\"כ","מחסן","תת־מחסן"];
    const lines = [headers.join(",")];

    grouped.forEach(g => {
      const labelText = g.labels.map(l =>
        `מק\"ט: ${l.makat || ""}, פק\"ע: ${l.pka || ""}, כמות: ${l.qty || ""}`
      ).join(" | ");

      const totalQty = g.labels.reduce((sum, l) => sum + Number(l.qty || 0), 0);

      const line = [
        formatDateTime(g.date,"date"),
        formatDateTime(g.time,"time"),
        g.worker || "",
        labelText,
        totalQty,
        g.warehouse || "",
        g.subWarehouse || ""
      ].map(v => `"${(v || "").toString().replace(/"/g,'""')}"`).join(",");

      lines.push(line);
    });

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "history.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", () => {
      applyFiltersAndRender();
    });

    const ths = document.querySelectorAll("#historyTable thead th[data-sort]");
    ths.forEach(th => {
      th.addEventListener("click", () => {
        const field = th.getAttribute("data-sort");
        sortRows(field, currentSort.dir, true);
      });
    });
  });
</script>

<script src="menu.js"></script>
</body>
</html>
