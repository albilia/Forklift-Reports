<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0">
  <title>היסטוריית דווחים</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #f5f5f5;
      direction: rtl;
    }

    .top-bar {
      background: #000000aa;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px #000;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 22px;
    }

    .content {
      padding: 10px;
    }

    .filters {
      background: #00000088;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .filters .field {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    .filters label {
      font-size: 13px;
      margin-bottom: 3px;
    }

    .filters input {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #777;
      font-size: 13px;
    }

    .filters button {
      padding: 7px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }

    .btn-main { background:#1e88e5; color:#fff; }
    .btn-today { background:#43a047; color:#fff; }
    .btn-refresh { background:#8e24aa; color:#fff; }
    .btn-export { background:#ffca28; color:#000; }
    .btn-back { background:#607d8b; color:#fff; }

    #summaryBar {
      background:#000000aa;
      border-radius:10px;
      padding:6px 10px;
      margin-bottom:10px;
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:15px;
    }

    #loading {
      font-size:13px;
      color:#ffeb3b;
      margin-bottom:5px;
      display:none;
    }

    table {
      width:100%;
      border-collapse:collapse;
      background:#000000aa;
      border-radius:10px;
      overflow:hidden;
      table-layout:fixed;
    }

    th, td {
      border:1px solid #555;
      padding:5px;
      font-size:12px;
      text-align:center;
    }

    th {
      background:#000000dd;
      cursor:pointer;
      user-select:none;
    }

    th.sort-asc::after { content:" ▲"; font-size:10px; }
    th.sort-desc::after { content:" ▼"; font-size:10px; }

    .labels-table {
      width:100%;
      border-collapse:collapse;
    }

    .labels-table th, .labels-table td {
      border:1px solid #444;
      padding:3px;
      font-size:11px;
    }

    .labels-table input {
      width:95%;
      font-size:11px;
      padding:2px;
      border-radius:4px;
      border:1px solid #777;
      text-align:center;
    }

    .save-btn {
      padding:3px 6px;
      font-size:11px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      background:#43a047;
      color:#fff;
      display:none;
    }

    .save-btn.visible {
      display:inline-block;
    }

    #mobileContainer {
      margin-top:10px;
    }

    .card {
      background:#000000aa;
      border-radius:10px;
      padding:8px;
      margin-bottom:8px;
      box-shadow:0 2px 4px #000;
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:4px;
    }

    .card-row {
      font-size:12px;
      margin-bottom:2px;
    }

    .card-labels {
      margin-top:4px;
      border-top:1px solid #444;
      padding-top:4px;
    }

    .card-labels table {
      width:100%;
      border-collapse:collapse;
    }

    .card-labels th, .card-labels td {
      border:1px solid #444;
      padding:3px;
      font-size:11px;
      text-align:center;
    }

    .card-labels input {
      width:95%;
      font-size:11px;
      padding:2px;
      border-radius:4px;
      border:1px solid #777;
      text-align:center;
    }

    .card-save {
      margin-top:4px;
      text-align:left;
    }

    .card-save button {
      padding:3px 6px;
      font-size:11px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      background:#43a047;
      color:#fff;
      display:none;
    }

    @media (max-width: 768px) {
      table { display:none; }
    }

    @media (min-width: 769px) {
      #mobileContainer { display:none; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>היסטוריית דווחים</h1>
  </div>

  <div class="content">
    <div class="filters">
      <div class="field">
        <label>תאריך התחלה:</label>
        <input type="date" id="startDate">
      </div>
      <div class="field">
        <label>תאריך סיום:</label>
        <input type="date" id="endDate">
      </div>
      <div class="field" style="flex:1;">
        <label>חיפוש חכם:</label>
        <input type="text" id="searchInput" placeholder="מק״ט / פק״ע / עובד / תת־מחסן">
      </div>
      <button class="btn-main" onclick="loadHistory()">טען דווחים</button>
      <button class="btn-today" onclick="loadToday()">היסטוריה מהיום</button>
      <button class="btn-refresh" onclick="refreshView()">רענן</button>
      <button class="btn-export" onclick="exportCsv()">ייצוא</button>
      <button class="btn-back" onclick="goBack()">חזור</button>
    </div>

    <div id="summaryBar">
      <span id="sumCount">סה״כ דיווחים: 0</span>
      <span id="sumPallets">סה״כ משטחים: 0</span>
    </div>

    <div id="loading">טוען נתונים...</div>

    <table id="historyTable">
      <thead>
        <tr>
          <th data-sort="date">תאריך</th>
          <th data-sort="time">שעה</th>
          <th data-sort="worker">עובד</th>
          <th>פירוט תוויות</th>
          <th data-sort="totalQty">סה״כ</th>
          <th data-sort="warehouse">מחסן</th>
          <th data-sort="subWarehouse">תת־מחסן</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="mobileContainer"></div>
  </div>

  <script>
    let allRows = [];
    let groupedShots = [];
    let currentSort = { field: null, dir: 1 };

    function goBack() {
      window.location.href = 'index.html';
    }

    function refreshView() {
      render();
    }

    function loadToday() {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
      loadHistory();
    }

    async function loadHistory() {
      document.getElementById('loading').style.display = 'block';
      try {
        const start = document.getElementById('startDate').value || '';
        const end = document.getElementById('endDate').value || '';
        const resp = await google.script.run
          .withSuccessHandler(onHistoryLoaded)
          .withFailureHandler(onHistoryError)
          .getHistoryData(start, end);
      } catch (e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
      }
    }

    function onHistoryError(err) {
      console.error('History error', err);
      document.getElementById('loading').style.display = 'none';
      alert('שגיאה בטעינת היסטוריה');
    }

    // צורת הנתונים המצופה מה־Apps Script:
    // [{ rowIndex, date, time, worker, makat, peka, qty, warehouse, subWarehouse, shotId }, ...]
    function onHistoryLoaded(data) {
      document.getElementById('loading').style.display = 'none';
      if (!Array.isArray(data)) data = [];

      // סינון שורות "פייק" / ריקות
      allRows = data.filter(r =>
        r &&
        r.date && String(r.date).trim() !== '' &&
        r.time && String(r.time).trim() !== '' &&
        r.worker && String(r.worker).trim() !== '' &&
        r.makat && String(r.makat).trim() !== '' &&
        r.qty && String(r.qty).trim() !== ''
      );

      groupByShot();
      render();
    }

    function groupByShot() {
      const map = new Map();
      for (const r of allRows) {
        // shotId יכול להגיע מהשרת. אם לא – נבנה מזהה לפי date+time+worker+warehouse+subWarehouse
        const key = r.shotId ||
          [r.date, r.time, r.worker, r.warehouse || '', r.subWarehouse || ''].join('|');

        if (!map.has(key)) {
          map.set(key, {
            shotId: key,
            date: r.date,
            time: r.time,
            worker: r.worker,
            warehouse: r.warehouse || '',
            subWarehouse: r.subWarehouse || '',
            labels: [],
            totalQty: 0
          });
        }
        const g = map.get(key);
        g.labels.push({
          rowIndex: r.rowIndex,
          makat: r.makat,
          peka: r.peka || '',
          qty: Number(r.qty) || 0
        });
        g.totalQty += Number(r.qty) || 0;
      }
      groupedShots = Array.from(map.values());
      updateSummary();
    }

    function updateSummary() {
      document.getElementById('sumCount').textContent =
        'סה״כ דיווחים: ' + groupedShots.length;
      const totalPallets = groupedShots.reduce((sum, g) => sum + g.totalQty, 0);
      document.getElementById('sumPallets').textContent =
        'סה״כ משטחים: ' + totalPallets;
    }

    function render() {
      const search = (document.getElementById('searchInput').value || '').trim();
      let filtered = groupedShots.slice();

      if (search) {
        const s = search.toLowerCase();
        filtered = filtered.filter(g => {
          if ((g.worker || '').toLowerCase().includes(s)) return true;
          if ((g.warehouse || '').toLowerCase().includes(s)) return true;
          if ((g.subWarehouse || '').toLowerCase().includes(s)) return true;
          if ((g.date || '').toLowerCase().includes(s)) return true;
          if ((g.time || '').toLowerCase().includes(s)) return true;
          for (const lbl of g.labels) {
            if ((lbl.makat || '').toLowerCase().includes(s)) return true;
            if ((lbl.peka || '').toLowerCase().includes(s)) return true;
          }
          return false;
        });
      }

      if (currentSort.field) {
        const f = currentSort.field;
        const dir = currentSort.dir;
        filtered.sort((a, b) => {
          let va = a[f] || '';
          let vb = b[f] || '';
          if (typeof va === 'string') va = va.toLowerCase();
          if (typeof vb === 'string') vb = vb.toLowerCase();
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return 0;
        });
      }

      renderDesktop(filtered);
      renderMobile(filtered);
    }

    function renderDesktop(list) {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = '';

      list.forEach((g, idx) => {
        const tr = document.createElement('tr');

        const tdDate = document.createElement('td');
        tdDate.textContent = g.date || '';
        tr.appendChild(tdDate);

        const tdTime = document.createElement('td');
        tdTime.textContent = g.time || '';
        tr.appendChild(tdTime);

        const tdWorker = document.createElement('td');
        tdWorker.textContent = g.worker || '';
        tr.appendChild(tdWorker);

        const tdLabels = document.createElement('td');
        tdLabels.appendChild(buildLabelsTable(g, false));
        tr.appendChild(tdLabels);

        const tdTotal = document.createElement('td');
        tdTotal.textContent = g.totalQty;
        tr.appendChild(tdTotal);

        const tdWh = document.createElement('td');
        tdWh.textContent = g.warehouse || '';
        tr.appendChild(tdWh);

        const tdSub = document.createElement('td');
        tdSub.textContent = g.subWarehouse || '';
        tr.appendChild(tdSub);

        tbody.appendChild(tr);
      });
    }

    function renderMobile(list) {
      const container = document.getElementById('mobileContainer');
      container.innerHTML = '';

      list.forEach((g, idx) => {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML =
          '<span>' + (g.date || '') + ' ' + (g.time || '') + '</span>' +
          '<span>' + (g.worker || '') + '</span>';
        card.appendChild(header);

        const row1 = document.createElement('div');
        row1.className = 'card-row';
        row1.textContent = 'מחסן: ' + (g.warehouse || '') +
          ' | תת־מחסן: ' + (g.subWarehouse || '');
        card.appendChild(row1);

        const row2 = document.createElement('div');
        row2.className = 'card-row';
        row2.textContent = 'סה״כ כמות: ' + g.totalQty;
        card.appendChild(row2);

        const labelsDiv = document.createElement('div');
        labelsDiv.className = 'card-labels';
        labelsDiv.appendChild(buildLabelsTable(g, true));
        card.appendChild(labelsDiv);

        container.appendChild(card);
      });
    }

    function buildLabelsTable(group, isMobile) {
      const table = document.createElement('table');
      table.className = 'labels-table';

      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      ['מק״ט', 'פק״ע', 'כמות', ''].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        hr.appendChild(th);
      });
      thead.appendChild(hr);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      group.labels.forEach((lbl, idx) => {
        const tr = document.createElement('tr');

        const tdMakat = document.createElement('td');
        const inpMakat = document.createElement('input');
        inpMakat.value = lbl.makat || '';
        inpMakat.dataset.groupId = group.shotId;
        inpMakat.dataset.labelIndex = idx;
        inpMakat.dataset.field = 'makat';
        inpMakat.addEventListener('input', onLabelChanged);
        tdMakat.appendChild(inpMakat);
        tr.appendChild(tdMakat);

        const tdPeka = document.createElement('td');
        const inpPeka = document.createElement('input');
        inpPeka.value = lbl.peka || '';
        inpPeka.dataset.groupId = group.shotId;
        inpPeka.dataset.labelIndex = idx;
        inpPeka.dataset.field = 'peka';
        inpPeka.addEventListener('input', onLabelChanged);
        tdPeka.appendChild(inpPeka);
        tr.appendChild(tdPeka);

        const tdQty = document.createElement('td');
        const inpQty = document.createElement('input');
        inpQty.type = 'number';
        inpQty.value = lbl.qty || 0;
        inpQty.dataset.groupId = group.shotId;
        inpQty.dataset.labelIndex = idx;
        inpQty.dataset.field = 'qty';
        inpQty.addEventListener('input', onLabelChanged);
        tdQty.appendChild(inpQty);
        tr.appendChild(tdQty);

        const tdSave = document.createElement('td');
        const btn = document.createElement('button');
        btn.textContent = 'שמור';
        btn.className = isMobile ? 'card-save-btn save-btn' : 'save-btn';
        btn.dataset.groupId = group.shotId;
        btn.dataset.labelIndex = idx;
        btn.addEventListener('click', onSaveLabel);
        tdSave.appendChild(btn);
        tr.appendChild(tdSave);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      return table;
    }

    function onLabelChanged(e) {
      const inp = e.target;
      const groupId = inp.dataset.groupId;
      const idx = Number(inp.dataset.labelIndex);
      const field = inp.dataset.field;

      const group = groupedShots.find(g => g.shotId === groupId);
      if (!group) return;
      const lbl = group.labels[idx];
      if (!lbl) return;

      let val = inp.value;
      if (field === 'qty') {
        val = Number(val) || 0;
      }

      lbl[field] = val;

      // עדכון סה״כ
      group.totalQty = group.labels.reduce((s, l) => s + (Number(l.qty) || 0), 0);
      updateSummary();
      render(); // כדי לעדכן את התצוגה של סה״כ

      // הצגת כפתור שמירה
      const table = inp.closest('table');
      if (!table) return;
      const btns = table.querySelectorAll('button.save-btn, .card-save-btn');
      btns.forEach(b => {
        if (b.dataset.groupId === groupId && Number(b.dataset.labelIndex) === idx) {
          b.classList.add('visible');
        }
      });
    }

    function onSaveLabel(e) {
      const btn = e.target;
      const groupId = btn.dataset.groupId;
      const idx = Number(btn.dataset.labelIndex);

      const group = groupedShots.find(g => g.shotId === groupId);
      if (!group) return;
      const lbl = group.labels[idx];
      if (!lbl) return;

      const payload = {
        rowIndex: lbl.rowIndex,
        makat: lbl.makat,
        peka: lbl.peka,
        qty: lbl.qty
      };

      btn.disabled = true;
      btn.textContent = 'שומר...';

      google.script.run
        .withSuccessHandler(() => {
          btn.textContent = 'נשמר';
          setTimeout(() => {
            btn.classList.remove('visible');
            btn.disabled = false;
            btn.textContent = 'שמור';
          }, 1000);
        })
        .withFailureHandler(err => {
          console.error('updateLabel error', err);
          alert('שגיאה בשמירת התווית');
          btn.disabled = false;
          btn.textContent = 'שמור';
        })
        .updateLabel(payload);
    }

    document.getElementById('searchInput').addEventListener('input', () => {
      render();
    });

    document.querySelectorAll('#historyTable th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (currentSort.field === field) {
          currentSort.dir *= -1;
        } else {
          currentSort.field = field;
          currentSort.dir = 1;
        }
        document.querySelectorAll('#historyTable th').forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });
        th.classList.add(currentSort.dir === 1 ? 'sort-asc' : 'sort-desc');
        render();
      });
    });

    function exportCsv() {
      if (!groupedShots.length) {
        alert('אין נתונים לייצוא');
        return;
      }
      let rows = [];
      rows.push(['תאריך','שעה','עובד','מחסן','תת־מחסן','מק״ט','פק״ע','כמות','סה״כ צילום']);
      groupedShots.forEach(g => {
        g.labels.forEach((lbl, i) => {
          rows.push([
            i === 0 ? g.date : '',
            i === 0 ? g.time : '',
            i === 0 ? g.worker : '',
            i === 0 ? g.warehouse : '',
            i === 0 ? g.subWarehouse : '',
            lbl.makat,
            lbl.peka,
            lbl.qty,
            i === 0 ? g.totalQty : ''
          ]);
        });
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'history.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // אפשר לקרוא ל-loadToday אוטומטית אם אתה רוצה:
    // window.onload = loadToday;
  </script>
</body>
</html>
