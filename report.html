<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>×¡×¨×™×§×ª ××œ××™ ×•×‘×™×§×•×¨×ª - OCR ××§×•××™</title>

  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px; margin: 0; text-align: center;
      background: linear-gradient(135deg, #1b1b1b 0%, #2a2a2a 100%);
      color: #f0f0f0;
    }

    .glass-box {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      margin: 10px auto;
      width: 92%;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .image-queue {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      margin-bottom: 10px;
      min-height: 80px;
    }

    .queued-img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #00e5ff;
      flex-shrink: 0;
    }

    .scan-animation {
      width: 160px;
      height: 160px;
      margin: 0 auto;
      cursor: pointer;
    }

    .preview-card {
      background: rgba(0, 229, 255, 0.1);
      border-right: 6px solid #00e5ff;
      padding: 12px;
      margin: 10px auto;
      border-radius: 10px;
      text-align: right;
      font-size: 15px;
      line-height: 1.6;
    }

    .edit-card {
      background: rgba(255, 255, 255, 0.05);
      border-right: 5px solid #ffeb3b;
      margin: 15px 0;
      padding: 15px;
      border-radius: 12px;
      text-align: right;
    }

    .edit-card label {
      display: block;
      font-size: 12px;
      color: #aaa;
      margin-top: 8px;
    }

    .edit-card input {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid #444;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .btn-del {
      background: #ff5252;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    #loader {
      display: none;
      font-weight: bold;
      margin: 20px 0;
      color: #ffeb3b;
      font-size: 18px;
    }

    button {
      font-size: 18px;
      padding: 12px;
      border-radius: 10px;
      margin: 10px auto;
      width: 90%;
      max-width: 350px;
      cursor: pointer;
      border: none;
      font-weight: bold;
      display: block;
    }

    #processAllBtn {
      background-color: #00e5ff;
      color: #000;
      display: none;
    }

    #saveBtn {
      background-color: #00c853;
      color: white;
      display: none;
    }

    #addLabelBtn {
      background-color: #607d8b;
      color: white;
      display: none;
      font-size: 14px;
      width: fit-content;
      padding: 8px 20px;
    }

    #summaryBox {
      background: rgba(0, 200, 83, 0.2);
      border: 1px solid #00c853;
      padding: 10px;
      border-radius: 10px;
      margin: 15px auto;
      display: none;
    }

    canvas {
      display: none;
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: #333;
      color: white;
      border: 1px solid #555;
    }

    h3 {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 5px;
      margin-bottom: 15px;
      color: #00e5ff;
    }
  </style>
</head><body>
  <h2 id="pageTitle">×¡×¨×™×§×ª ××œ××™ ×•×‘×™×§×•×¨×ª</h2>

  <div id="warehouseInfo" class="glass-box">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>

  <div id="subSelectBox" class="glass-box" style="display:none;">
    <select id="subWarehouseSelect" onchange="selectSubWarehouse()">
      <option value="">×‘×—×¨ ×ª×ªÖ¾××—×¡×Ÿ</option>
      <option>×“× ×™×“×™×Ÿ</option>
      <option>×‘×¦×§ ×¡×•×›×¨ ×™××™×Ÿ</option>
      <option>×‘×¦×§ ×¡×•×›×¨ ×©×××œ</option>
      <option>×©×“×¨×” ××¨×›×–×™×ª</option>
      <option>××—×¡×Ÿ ×—×“×©</option>
      <option>×¦×¨×¤×ª×™</option>
    </select>
  </div>

  <div class="image-queue" id="imageQueue"></div>

  <lottie-player
      id="lottie"
      src="qr.json"
      background="transparent"
      speed="1"
      loop
      autoplay
      class="scan-animation"
      onclick="triggerCamera();">
  </lottie-player>

  <input id="cameraInput" type="file" accept="image/*" capture="environment" onchange="addToQueue(this)" style="display:none;">

  <canvas id="processingCanvas"></canvas>

  <div id="loader">××¢×‘×“ ×ª××•× ×•×ª...</div>

  <div id="previewArea" class="glass-box" style="display:none;">
    <h3>× ×ª×•× ×™× ×©×–×•×”×• ×‘×¡×¨×™×§×” (Preview)</h3>
    <div id="ocrResultsPreview"></div>
  </div>

  <div id="reviewArea" class="glass-box" style="display:none;">
    <h3>×¢×¨×™×›×” ×•××™×©×•×¨ ×¡×•×¤×™</h3>
    <div id="summaryBox"></div>
    <div id="labelsContainer"></div>
    <button id="addLabelBtn" onclick="addBlankLabel()">+ ×”×•×¡×£ ×ª×•×•×™×ª ×™×“× ×™×ª</button>
  </div>

  <button id="processAllBtn" onclick="runBatchOCR()">×©×œ×— ×œ×¡×¨×™×§×”</button>
  <button id="saveBtn" onclick="saveAll()">×©×’×¨ ×“×•×•×— ×¡×•×¤×™ ×œ××¢×¨×›×ª</button>

  <button onclick="window.location.href='dashboard.html?phone='+phone+'&name='+name"
          style="background: transparent;
          color: #aaa; text-decoration: underline;">
    ×‘×™×˜×•×œ ×•×—×–×¨×”
  </button><script>

console.log("=== OCR DEBUG SESSION START ===");

const API_URL = "https://script.google.com/macros/s/AKfycbwJX4IaxmTmNx0re1ifoEPxgbsh6rAkFfmaehHDkJKW0LViqLtnkiCCg8uzsaA3PTtJEg/exec";

const params = new URLSearchParams(window.location.search);
const phone = params.get("phone");
const name = params.get("name");
const category = params.get("category");

let main = "";
let finished = "";
let imageQueue = [];
let labels = [];
let isProcessing = false;

if (category === "raw") {
  main = "××—×¡×Ÿ ×—×•××¨×™ ×’×œ×";
  document.getElementById("warehouseInfo").innerText = main;
} else {
  main = "××—×¡×Ÿ ×ª×•×¦×¨ ×’××¨";
  document.getElementById("warehouseInfo").innerText = main;
  document.getElementById("subSelectBox").style.display = "block";
}

function selectSubWarehouse() {
  finished = document.getElementById("subWarehouseSelect").value;
}

function triggerCamera() {
  if (!isProcessing) {
    document.getElementById("cameraInput").click();
  }
}

function addToQueue(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.getElementById("processingCanvas");
      const ctx = canvas.getContext("2d");

      const maxDim = 1600;
      let w = img.width, h = img.height;
      const scale = Math.min(maxDim / w, maxDim / h, 1);

      canvas.width = w * scale;
      canvas.height = h * scale;

      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const dataURL = canvas.toDataURL("image/png");
      imageQueue.push(dataURL);
      updateQueueUI();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = "";
}

function updateQueueUI() {
  const container = document.getElementById("imageQueue");
  container.innerHTML = imageQueue
    .map(src => `<img src="${src}" class="queued-img">`)
    .join("");
  document.getElementById("processAllBtn").style.display =
    imageQueue.length ? "block" : "none";
}

async function loadOCR() {
  const worker = await Tesseract.createWorker("heb+eng", 1, {
    logger: m => console.log("ğŸ“¡ OCR LOG:", m)
  });

  await worker.setParameters({
    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
    preserve_interword_spaces: "1"
  });

  return worker;
}

async function runBatchOCR() {
  if (isProcessing || !imageQueue.length) return;

  isProcessing = true;
  document.getElementById("loader").style.display = "block";
  document.getElementById("lottie").style.display = "none";

  const worker = await loadOCR();

  for (let i = 0; i < imageQueue.length; i++) {
    const imgData = imageQueue[i];
    const { data: { text } } = await worker.recognize(imgData);

    window.lastOCRText = text;

    parseText(text);
  }

  await worker.terminate();

  imageQueue = [];
  updateQueueUI();

  isProcessing = false;
  document.getElementById("loader").style.display = "none";
  document.getElementById("previewArea").style.display = "block";
  document.getElementById("reviewArea").style.display = "block";
  document.getElementById("addLabelBtn").style.display = "block";
  document.getElementById("saveBtn").style.display = "block";

  renderPreviewDisplay();
  renderReview();
}

function cleanOCRText(text) {
  return text
    .replace(/O/g, "0")
    .replace(/I/g, "1")
    .replace(/S/g, "5")
    .replace(/[×´â€â€]/g, '"')
    .replace(/[×³â€™]/g, "'")
    .replace(/[|\\/_'":;=]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}//
// â­â­â­â­â­ parseText â€” ×’×¨×¡×” ××ª×•×§× ×ª â­â­â­â­â­
//
function parseText(text) {
  const normalized = cleanOCRText(text);

  // --- ××§×´×˜: 9 ×¡×¤×¨×•×ª, ×•×× ×™×© ×¨×§ 8 × ×•×¡×™×£ 1 ××§×“×™××” ---
  let makat = "";
  const makat9 = normalized.match(/\b\d{9}\b/);
  const makat8 = normalized.match(/\b\d{8}\b/);

  if (makat9) {
    makat = makat9[0];
  } else if (makat8) {
    makat = "1" + makat8[0];
  }

  // --- ×¤×§×´×¢: ×§×•×“× ××—×¤×©×™× CON/WAF/SUG ---
  let pka = "";
  let pkaMatch = normalized.match(/(?:CON|WAF|SUG)\s*?(\d{5,12})/i);

  if (pkaMatch && pkaMatch[1]) {
    pka = pkaMatch[1].slice(-3);
  } else {
    // fallback: ×× ×”â€‘OCR ×œ× ×§×¨× ××ª ×”××•×ª×™×•×ª â€” × ×—×¤×© ××¡×¤×¨ ××¨×•×š
    const longNums = normalized.match(/\b\d{7,12}\b/g) || [];
    if (longNums.length) {
      pka = longNums[0].slice(-3);
    }
  }

  // --- ×›××•×ª ---
  let qty = "";
  const qtyWord = normalized.match(/×›××•×ª[^0-9]{0,10}(\d{1,4})/);

  if (qtyWord) {
    qty = qtyWord[1];
  } else {
    const allNums = normalized.match(/\b\d{2,4}\b/g) || [];
    const candidate = allNums.find(n => {
      if (n === makat) return false;
      if (n === pka) return false;
      if (/^\d{2}$/.test(n) && normalized.includes(`${n}/`)) return false;
      return true;
    });
    if (candidate) qty = candidate;
  }

  labels.push({ makat, pka, qty, palletId: "" });
}

//
// â­â­â­â­â­ ×ª×¦×•×’×” ××§×“×™××” â­â­â­â­â­
//
function renderPreviewDisplay() {
  const container = document.getElementById("ocrResultsPreview");
  container.innerHTML = "";
  labels.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "preview-card";
    div.innerHTML = `
      <strong>×ª×•×•×™×ª ${index + 1}:</strong><br>
      ××§"×˜: ${item.makat || "---"} | ×¤×§"×¢: ${item.pka || "---"} | ×›××•×ª: ${item.qty || "---"}
    `;
    container.appendChild(div);
  });
}

//
// â­â­â­â­â­ ×”×•×¡×¤×ª ×ª×•×•×™×ª ×™×“× ×™×ª â­â­â­â­â­
//
function addBlankLabel() {
  labels.push({ makat: "", pka: "", qty: "", palletId: "" });
  renderReview();
  renderPreviewDisplay();
}

//
// â­â­â­â­â­ ×¢×¨×™×›×” ×•××™×©×•×¨ â­â­â­â­â­
//
function renderReview() {
  const container = document.getElementById("labelsContainer");
  container.innerHTML = "";
  labels.forEach((item, index) => {
    const card = document.createElement("div");
    card.className = "edit-card";
    card.innerHTML = `
      <div class="card-header">
        <strong>×¢×¨×™×›×ª ×ª×•×•×™×ª ${index + 1}</strong>
        <button class="btn-del" onclick="deleteLabel(${index})">××—×™×§×”</button>
      </div>
      <label>××§"×˜</label>
      <input type="text" value="${item.makat || ''}" oninput="updateVal(${index}, 'makat', this.value)">
      <label>×¤×§"×¢</label>
      <input type="text" value="${item.pka || ''}" oninput="updateVal(${index}, 'pka', this.value)">
      <label>×›××•×ª</label>
      <input type="number" value="${item.qty || ''}" oninput="updateVal(${index}, 'qty', this.value); updateSummary();">
      <label>××¡×¤×¨ ××©×˜×—</label>
      <input type="text" value="${item.palletId || ''}" oninput="updateVal(${index}, 'palletId', this.value)">
    `;
    container.appendChild(card);
  });
  updateSummary();
}

function updateVal(index, field, val) {
  labels[index][field] = val;
  renderPreviewDisplay();
}

function deleteLabel(index) {
  labels.splice(index, 1);
  renderReview();
  renderPreviewDisplay();
}

//
// â­â­â­â­â­ ×¡×™×›×•× ×›××•×™×•×ª â­â­â­â­â­
//
function updateSummary() {
  const totalQty = labels.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
  const sBox = document.getElementById("summaryBox");
  sBox.style.display = labels.length ? "block" : "none";
  sBox.innerHTML = `×¡×”"×› ×™×—×™×“×•×ª: <strong>${totalQty}</strong> | ×ª×•×•×™×•×ª: <strong>${labels.length}</strong>`;
}

//
// â­â­â­â­â­ ×©××™×¨×” ×œ×©×¨×ª â­â­â­â­â­
//
async function saveAll() {
  if (category === "finished" && !finished) {
    alert("×—×•×‘×” ×œ×‘×—×•×¨ ×ª×ª-××—×¡×Ÿ!");
    return;
  }
  if (!labels.length) {
    alert("××™×Ÿ × ×ª×•× ×™× ×œ×©××™×¨×”");
    return;
  }

  document.getElementById("loader").style.display = "block";
  document.getElementById("loader").innerText = "×©×•××¨ ×‘×“××˜×”-×‘×™×™×¡...";

  const reports = labels.map(l => ({
    makat: l.makat,
    pka: l.pka,
    qty: Number(l.qty),
    palletId: l.palletId
  }));

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "saveReport",
        phone,
        name,
        main,
        finished,
        reports
      })
    });

    const data = await res.json();

    if (data.success) {
      alert("×”×“×•×•×— × ×©××¨ ×‘×”×¦×œ×—×”!");
      window.location.href = `dashboard.html?phone=${phone}&name=${name}`;
    } else {
      alert("×©×’×™××” ××”×©×¨×ª: " + data.error);
    }

  } catch (e) {
    alert("×©×’×™××ª ×ª×§×©×•×¨×ª");
  }

  document.getElementById("loader").style.display = "none";
}

console.log("=== OCR DEBUG SESSION READY ===");

</script>

</body>
</html>