<script>
  function triggerCamera() {
    const flash = document.getElementById("flash");
    flash.classList.add("active");
    setTimeout(() => flash.classList.remove("active"), 150);

    if (navigator.vibrate) navigator.vibrate(120);

    document.getElementById("cameraInput").click();
  }

  /* ⭐ API URL — הכתובת החדשה */
  const API_URL = "https://script.google.com/macros/s/AKfycbz0ZuXpjRQXUo76gtmRznhFqHM0cqI1sJFHnAGkLUascRW5W6DoW2f0GF4mGGHiqaaF9A/exec";

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  const name = params.get("name");
  const main = params.get("main");
  const finished = params.get("finished");

  if (!token) {
    alert("שגיאה: אין טוקן זיהוי");
    window.location.href = "index.html";
  }

  let rawReports = [];
  let finishedReports = [];
  let pendingImages = [];

  function goBack() {
    window.location.href = `dashboard.html?token=${token}&name=${encodeURIComponent(name)}`;
  }

  function handleImage(input) {
    const files = input.files;
    if (!files || files.length === 0) return;

    for (const file of files) {
      pendingImages.push(file);
    }

    const lastFile = files[files.length - 1];
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById("preview");
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(lastFile);

    document.getElementById("processAllBtn").style.display = "block";
  }

  async function processAll() {
    if (pendingImages.length === 0) return;

    document.getElementById("loader").innerText = "מעבד תמונות...";
    document.getElementById("loader").style.display = "block";

    for (const file of pendingImages) {
      await processSingleImage(file);
    }

    pendingImages = [];
    document.getElementById("loader").style.display = "none";
    document.getElementById("saveBtn").style.display = "block";
    document.getElementById("processAllBtn").style.display = "none";
  }

  async function processSingleImage(file) {
    return new Promise(resolve => {
      document.getElementById("clickSound").play().catch(()=>{});

      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64 = e.target.result;

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
              action: "processImage",
              image: base64,
              main: main
            })
          });

          const data = await response.json();

          if (data.parsed && data.parsed.reports && data.parsed.reports.length > 0) {
            if (main === "raw") {
              const first = data.parsed.reports[0];
              if (first) {
                rawReports.push(first);
                showRawList();
              }
            } else {
              finishedReports.push(...data.parsed.reports);
              showFinishedList();
            }
          }
        } catch (err) {
          console.log("OCR error", err);
        }

        resolve();
      };

      reader.readAsDataURL(file);
    });
  }

  function showRawList() {
    const box = document.getElementById("ocrList");
    box.innerHTML = "";

    rawReports.forEach((r, i) => {
      box.innerHTML += `
        <div class="ocr-box">
          <b>צילום ${i+1}:</b><br>
          מק״ט: ${r.makat}<br>
          כמות: ${r.qty}
        </div>
      `;
    });
  }

  function showFinishedList() {
    const box = document.getElementById("ocrList");
    box.innerHTML = "";

    finishedReports.forEach((r, i) => {
      box.innerHTML += `
        <div class="ocr-box">
          <b>תווית ${i+1}:</b><br>
          מק״ט: ${r.makat}<br>
          פק״ע: ${r.pka}<br>
          כמות: ${r.qty}
        </div>
      `;
    });
  }

  /* ⭐ פונקציה חדשה — שמירת תוצר גמר בודד */
  async function saveSingleFinishedReport(report) {
    const payload = {
      action: "saveReport",
      token,
      ocr: { reports: [report] },
      finishedWarehouse: finished
    };

    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
  }

  /* ⭐ שמירה — חומרי גלם כרגיל, תוצר גמר SHOT נפרד */
  async function saveAll() {
    document.getElementById("loader").innerText = "שומר דיווח...";
    document.getElementById("loader").style.display = "block";

    if (main === "raw") {
      const payload = {
        action: "saveRawMaterialBatch",
        token,
        reports: rawReports
      };

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        document.getElementById("loader").style.display = "none";

        if (!data.success) {
          alert("שגיאה בשמירת הדיווח");
          return;
        }

        alert("הדיווח נשמר בהצלחה!");
        goBack();

      } catch (err) {
        alert("שגיאה בחיבור לשרת");
        document.getElementById("loader").style.display = "none";
      }

    } else {
      try {
        for (const report of finishedReports) {
          await saveSingleFinishedReport(report);
        }

        document.getElementById("loader").style.display = "none";
        alert("הדיווח נשמר בהצלחה!");
        goBack();

      } catch (err) {
        alert("שגיאה בחיבור לשרת");
        document.getElementById("loader").style.display = "none";
      }
    }
  }
</script>
